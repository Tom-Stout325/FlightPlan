{% load static %}
{% load crispy_forms_tags %}

<style>
  .drop-zone {
    border: 2px dashed #ccc;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    background-color: #f9f9f9;
    transition: background-color 0.3s;
  }

  .drop-zone:hover {
    background-color: #f1f1f1;
  }

  .form-section {
    margin-bottom: 1.5rem;
  }

  .preview-img {
    max-height: 180px;
  }
</style>

<div class="container mt-4">
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="row">
      {% for field in form.visible_fields %}
        {% if field.name not in 'faa_certificate receipt active deducted_full_cost' %}
          <div class="col-md-4 mb-3">
            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
            {{ field }}
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <div class="row">
      <div class="col-md-6 mb-3 d-flex align-items-center">
        <label class="me-2">{{ form.deducted_full_cost.label_tag }}</label>
        {{ form.deducted_full_cost }}
      </div>
      <div class="col-md-6 mb-3 d-flex align-items-center">
        <label class="me-2">{{ form.active.label_tag }}</label>
        {{ form.active }}
      </div>
    </div>

    <div class="row">
      <!-- FAA Certificate -->
      <div class="col-md-6 mb-4">
        <label for="id_faa_certificate" class="form-label">FAA Certificate</label>
        <div class="drop-zone" id="faa-drop-zone">
          <p><i class="fas fa-upload fa-lg text-primary"></i></p>
          <p>Drag & drop or click to upload FAA Certificate (PDF/Image)</p>
          <input type="file" name="faa_certificate" id="id_faa_certificate" accept=".pdf,.jpg,.jpeg,.png" hidden>
        </div>
        {% if form.instance.faa_certificate %}
          <div id="faa-preview" class="mt-2 text-center small text-muted">
            {% if form.instance.faa_certificate.url|slice:"-4:" == ".pdf" %}
              <a href="{{ form.instance.faa_certificate.url }}" target="_blank">
                <i class="fas fa-file-pdf"></i> View PDF
              </a>
            {% else %}
              <img src="{{ form.instance.faa_certificate.url }}" class="img-fluid rounded border mt-2 preview-img">
            {% endif %}
          </div>
        {% endif %}
      </div>

      <!-- Receipt -->
      <div class="col-md-6 mb-4">
        <label for="id_receipt" class="form-label">Receipt</label>
        <div class="drop-zone" id="receipt-drop-zone">
          <p><i class="fas fa-upload fa-lg text-primary"></i></p>
          <p>Drag & drop or click to upload Receipt (PDF/Image)</p>
          <input type="file" name="receipt" id="id_receipt" accept=".pdf,.jpg,.jpeg,.png" hidden>
        </div>
        {% if form.instance.receipt %}
          <div id="receipt-preview" class="mt-2 text-center small text-muted">
            {% if form.instance.receipt.url|slice:"-4:" == ".pdf" %}
              <a href="{{ form.instance.receipt.url }}" target="_blank">
                <i class="fas fa-file-pdf"></i> View PDF
              </a>
            {% else %}
              <img src="{{ form.instance.receipt.url }}" class="img-fluid rounded border mt-2 preview-img">
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>

    <div class="text-end">
      <button type="submit" class="btn btn-success">
        <i class="fas fa-save"></i> Save Equipment
      </button>
    </div>
  </form>
</div>

<form method="post" novalidate>
  {% csrf_token %}

  <!-- your usual form rendering -->
  <!-- Example: -->
  <div class="mb-3">
    <label for="id_equipment_type" class="form-label">Equipment Type</label>
    {{ form.equipment_type }}
  </div>

  <div class="mb-3">
    <label for="id_name" class="form-label">Equipment Name</label>
    {{ form.name }}
    <div id="drone-name-helper" class="form-text text-muted small"></div>
  </div>

  <!-- Hidden FK field (if not rendered via form already) -->
  <input type="hidden" id="id_drone_safety_profile" name="drone_safety_profile">

  <button type="submit" class="btn btn-primary w-100">Save Equipment</button>
</form>

<script>
  (function () {
    const equipmentTypeField = document.getElementById("id_equipment_type");
    const nameField = document.getElementById("id_name");
    const safetyProfileField = document.getElementById("id_drone_safety_profile");
    const helper = document.getElementById("drone-name-helper");

    if (!equipmentTypeField || !nameField || !safetyProfileField) {
      return;
    }

    async function checkDroneName() {
      const type = equipmentTypeField.value;
      if (type !== "Drone") {
        helper.textContent = "";
        safetyProfileField.value = "";
        return;
      }

      const name = nameField.value.trim();
      if (!name) {
        return;
      }


      const brandField = document.getElementById("id_brand");
      const brand = brandField ? brandField.value : "";

      const params = new URLSearchParams({
        name: name,
        brand: brand,
      });

      try {
        const response = await fetch("{% url 'equipment:drone_profile_suggest' %}?" + params.toString(), {
          headers: {
            "X-Requested-With": "XMLHttpRequest",
          },
        });

        if (!response.ok) {
          console.error("Drone suggest API error", response.status);
          return;
        }

        const data = await response.json();
        if (!data.found) {
          helper.textContent = "Your drone is not in our database. You’ll need to enter safety features manually in the waiver form.";
          safetyProfileField.value = "";
          return;
        }

        const msg = `Is this the correct drone: "${data.full_display_name}"?`;
        const ok = window.confirm(msg);

        if (ok) {
          // Lock in our canonical name + FK
          nameField.value = data.full_display_name;
          safetyProfileField.value = data.id;
          helper.textContent = "Matched known drone profile. Safety features will be available in waiver planning.";
        } else {
          helper.textContent = "Your drone is not in our database. You’ll need to enter safety features manually in the waiver form.";
          safetyProfileField.value = "";
        }
      } catch (err) {
        console.error("Error calling drone suggest API", err);
      }
    }

    // Run this when the name field loses focus
    nameField.addEventListener("blur", checkDroneName);
  })();
</script>

<script>
  document.querySelectorAll('.drop-zone').forEach(zone => {
    const input = zone.querySelector('input');

    zone.addEventListener('click', () => input.click());

    zone.addEventListener('dragover', (e) => {
      e.preventDefault();
      zone.classList.add('bg-light');
    });

    zone.addEventListener('dragleave', () => {
      zone.classList.remove('bg-light');
    });

    zone.addEventListener('drop', (e) => {
      e.preventDefault();
      zone.classList.remove('bg-light');
      input.files = e.dataTransfer.files;
    });
  });
</script>
