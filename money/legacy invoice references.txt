
money/services/invoice_pdf.py
15:def generate_invoice_pdf(invoice: InvoiceV2, *, force: bool = False) -> bool:

money/management/commands/seed_money_dev.py
11:    Invoice,
37:        # --- Required base objects for Invoice / Transaction ---
74:            invoice, created = Invoice.objects.get_or_create(

money/urls.py
155:    path("invoices/legacy/<int:pk>/", LegacyInvoiceDetailView.as_view(), name="legacy_invoice_detail"),
156:    path("invoices/legacy/file/<path:filename>/", LegacyFileInvoiceDetailView.as_view(), name="legacy_file_invoice_detail"),

money/unified_invoices.py
38:        'legacy_model' -> legacy Invoice instance in the DB
178:# Legacy DB invoices (old Invoice model)
182:    Legacy invoices that still exist in the old Invoice model.
185:        Invoice.objects
227:            detail_url = reverse("money:legacy_invoice_detail", args=[inv.pk])
274:        LEGACY_INVOICE_DIR = "legacy_invoices/"
276:    legacy_dir = getattr(settings, "LEGACY_INVOICE_DIR", "legacy_invoices/")
303:                "money:legacy_file_invoice_detail",

money/signals.py
8:from money.models import InvoiceItemV2, InvoiceV2
9:from money.services.invoice_pdf import generate_invoice_pdf
14:@receiver(post_save, sender=Invoice)
18:    post_save.disconnect(update_search_vector, sender=Invoice)
33:        post_save.connect(update_search_vector, sender=Invoice)
42:        generate_invoice_pdf(invoice, force=True)
46:@receiver(post_save, sender=InvoiceItemV2)
47:def invoice_item_v2_saved(sender, instance: InvoiceItemV2, **kwargs):
56:@receiver(post_delete, sender=InvoiceItemV2)
57:def invoice_item_v2_deleted(sender, instance: InvoiceItemV2, **kwargs):

money/forms/invoices/invoice_v2.py
11:from money.models import Client, Event, InvoiceItemV2, InvoiceV2, Service, SubCategory
36:# Invoice header form
109:class InvoiceItemV2Form(forms.ModelForm):
111:        model = InvoiceItemV2
160:class BaseInvoiceItemV2FormSet(BaseInlineFormSet):
163:    - InvoiceItemV2.clean() requires item.user to be set BEFORE validation.
213:InvoiceItemV2FormSet = inlineformset_factory(
215:    model=InvoiceItemV2,
216:    form=InvoiceItemV2Form,
217:    formset=BaseInvoiceItemV2FormSet,

money/views/invoices_legacy.py
10:from money.models import Invoice  # legacy Invoice model
15:    Read-only detail page for legacy invoices stored in the old Invoice model.
17:    URL name:  money:legacy_invoice_detail
18:    Template:  money/invoices/legacy_invoice_detail.html
20:    template_name = "money/invoices/legacy_invoice_detail.html"
24:            Invoice.objects.select_related("client", "event"),
46:    URL name:  money:legacy_file_invoice_detail
47:    Template:  money/invoices/legacy_file_invoice_detail.html
49:    template_name = "money/invoices/legacy_file_invoice_detail.html"
52:        legacy_dir = getattr(settings, "LEGACY_INVOICE_DIR", "legacy_invoices/")

money/migrations/0003_remove_invoicev2_uniq_invoicev2_per_client_and_more.py
21:            field=models.ForeignKey(blank=True, editable=False, help_text='Set automatically from sub-category.', null=True, on_delete=django.db.models.deletion.PROTECT, related_name='invoice_items_v2', to='money.category'),
26:            field=models.ForeignKey(blank=True, help_text='Choose the sub-category; category will be set automatically.', null=True, on_delete=django.db.models.deletion.PROTECT, related_name='invoice_items_v2', to='money.subcategory'),

money/management/commands/migrate_legacy_invoices.py
8:from money.models import Invoice, InvoiceV2, InvoiceItemV2
9:from money.services.invoice_pdf import generate_invoice_pdf
39:    help = "Migrate legacy Invoice + InvoiceItem records into InvoiceV2."
58:            Invoice.objects
86:    def _migrate_one_invoice(self, legacy: Invoice) -> int:
154:            InvoiceItemV2.objects.create(
165:                InvoiceItemV2.objects.create(
189:        generate_invoice_pdf(invoice_v2, force=True)

money/views/reports.py
20:from money.models import CompanyProfile, Invoice, InvoiceV2, Transaction
589:    model: str  # "Invoice" or "InvoiceV2"
594:        Invoice.objects.filter(client__user=user, date__year=year)
612:            model="Invoice",

money/views/invoices_unified.py
24:      - Legacy Invoice DB records

money/migrations/0002_invoicev2_invoiceitemv2_and_more.py
24:                ('date', models.DateField(help_text='Invoice date.')),
56:            name='InvoiceItemV2',
62:                ('category', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='invoice_items_v2', to='money.category')),
64:                ('sub_cat', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='invoice_items_v2', to='money.subcategory')),

money/forms/transactions/transactions.py
27:        label="Invoice Number (Optional)",

money/views/transactions.py
130:            {"field": "invoice_number", "label": "Invoice #"},
314:            "Invoice Number",

money/migrations/0006_miles_invoice_v2_alter_miles_event_and_more.py
17:            field=models.ForeignKey(blank=True, help_text='If set, this mileage entry is tied to an Invoice V2.', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='mileage_entries', to='money.invoicev2'),

money/views/tax_tools.py
570:            "Invoice #",

money/models.py
618:        help_text="If set, this mileage entry is tied to an Invoice V2.",
903:# Invoice V2 (user-scoped)
933:    date = models.DateField(help_text="Invoice date.")
1025:            raise ValueError("Invoice date is required to generate invoice_number.")
1027:            raise ValueError("Invoice user is required to generate invoice_number.")
1218:        description = self.event_name or f"Invoice {self.invoice_number}"
1282:class InvoiceItemV2(OwnedModelMixin):
1287:    sub_cat = models.ForeignKey("SubCategory", on_delete=models.PROTECT, null=True, blank=True, related_name="invoice_items_v2", help_text="Choose the sub-category; category will be set automatically.",)
1288:    category = models.ForeignKey("Category", on_delete=models.PROTECT, null=True, blank=True, related_name="invoice_items_v2", editable=False, help_text="Set automatically from sub-category.",)
1315:            raise ValidationError({"invoice": "Invoice is required."})
1350:class Invoice(models.Model):
1352:    Deprecated legacy Invoice.
1357:    client = models.ForeignKey("Client", on_delete=models.PROTECT, related_name="legacy_invoices")
1360:    event = models.ForeignKey("Event", on_delete=models.PROTECT, related_name="legacy_invoices")
1361:    service = models.ForeignKey("Service", on_delete=models.PROTECT, related_name="legacy_invoices")
1408:        return self.invoice_number or f"Invoice {self.pk}"
1509:class InvoiceItem(models.Model):
1510:    invoice = models.ForeignKey("Invoice", on_delete=models.CASCADE, related_name="items")

money/migrations/0008_category_category_type.py
9:        ('money', '0007_alter_invoice_pdf_url_alter_invoicev2_pdf_url'),

money/views/invoices_v2.py
19:from money.forms.invoices.invoice_v2 import InvoiceItemV2FormSet, InvoiceV2Form
118:        items_formset = InvoiceItemV2FormSet(
132:            messages.success(request, "Invoice created.")
137:        items_formset = InvoiceItemV2FormSet(
155:    Update InvoiceV2 + inline InvoiceItemV2 rows.
163:        items_formset = InvoiceItemV2FormSet(
185:            messages.success(request, "Invoice updated.")
190:        items_formset = InvoiceItemV2FormSet(
216:        messages.success(request, "Invoice deleted.")
267:        messages.success(request, "Invoice marked as paid and income transaction recorded.")
279:            messages.info(request, "Invoice already issued.")
293:        messages.success(request, "Invoice issued.")
342:    subject = f"Invoice {invoice.invoice_number or invoice.pk}"
372:    messages.success(request, f"Invoice emailed to {to_email}.")

money/migrations/0001_initial.py
105:            name='Invoice',
269:            name='InvoiceItem',

money/admin.py
7:    Invoice,
8:    InvoiceItem,
10:    InvoiceItemV2,
78:    Legacy Invoice admin (keep as-is for historical access).
182:        ("Invoice Defaults", {
238:# InvoiceV2 + InvoiceItemV2 admin
241:class InvoiceItemV2Inline(admin.TabularInline):
242:    model = InvoiceItemV2
257:    inlines = [InvoiceItemV2Inline]
366:                    f"Error processing Invoice {invoice.invoice_number or invoice.pk}: {exc}",
384:@admin.register(InvoiceItemV2)
385:class InvoiceItemV2Admin(admin.ModelAdmin):
485:    @admin.display(description="Invoice")
497:admin.site.register(InvoiceItem)
503:admin.site.register(Invoice, InvoiceAdmin)

money/migrations/0017_alter_client_options_alter_service_options_and_more.py
211:            field=models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='legacy_invoices', to='money.client'),
216:            field=models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='legacy_invoices', to='money.event'),
221:            field=models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='legacy_invoices', to='money.service'),

money/templates/money/transactions/transactions.html
131:            <th class="d-none d-md-table-cell">Invoice #</th>

money/templates/money/reports/travel_summary_pdf.html
49:        <th style="width: 12%;">Invoice #</th>
51:        <th class="num" style="width: 13%;">Invoice Amount</th>

money/templates/money/reports/DEL_invoice_summary.html
4:{% block title %}Invoice Summary{% endblock %}
8:    <h2 class="text-primary mb-1">Invoice Summary</h2>
26:                <th style="width: 10%;">Invoice #</th>
28:                <th class="text-end" style="width: 15%;">Invoice Amount</th>
37:                    <!-- Invoice # -->
59:                    <!-- Invoice Amount (from the Invoice object) -->

money/templates/money/reports/travel_summary.html
41:          <th style="width: 9%;">Invoice #</th>
43:          <th class="text-end" style="width: 12%;">Invoice Amount</th>

money/templates/money/taxes/mileage_report_pdf.html
74:        <th>Invoice #</th>

money/templates/money/invoices/invoice_detail.html
7:  <title>Invoice {{ invoice.invoice_number }}</title>
56:      <div class="h2">Invoice</div>
57:      <div>Invoice #: {{ invoice.invoice_number }}</div>

money/templates/money/transactions/transactions_detail_view.html
50:        <dt class="col-sm-4 fw-semibold">Invoice #:</dt>

money/templates/money/taxes/mileage_log.html
181:          <th class="d-none d-md-table-cell">Invoice #</th>

money/templates/money/invoices/invoice_v2_list.html
81:  <!-- Invoice table -->
87:            <th scope="col">Invoice #</th>
98:              <!-- Invoice number + quick actions -->
202:        <nav aria-label="Invoice pagination">

money/templates/money/taxes/vehicle_detail.html
94:              <th class="d-none d-md-table-cell">Invoice</th>

money/templates/money/invoices/invoice_update.html
11:      <h3 class="mb-0">Edit Invoice</h3>
28:        <h5 class="mb-3 text-success">Invoice Items</h5>

money/templates/money/invoices/invoice_pdf_export.html
4:  {% block title %}Invoice#: {{invoice.invoice_numb}}{% endblock %}
9:  {% block title %}Invoice#: {{invoice.invoice_numb}}{% endblock %}
68:    <h1>{{ BRAND.display_name }} â€“ Invoice Summary</h1>
74:        <th>Invoice #</th>

money/templates/money/invoices/invoice_add.html
35:      <h3 class="mb-0 text-center">Create Invoice</h3>
59:  <h5 class="mb-3 text-success">Invoice Items</h5>
115:    <button type="submit" class="btn btn-success">ðŸ’¾ Save Invoice</button>

money/templates/money/invoices/legacy_invoice_detail.html
5:  Legacy Invoice {{ invoice.invoice_number }}
24:            Legacy Invoice {{ invoice.invoice_number|default:"(unknown)" }}
28:            <span class="badge bg-secondary">Legacy Invoice (Read-only)</span>
37:            <dt class="col-4 col-md-3">Invoice date</dt>
133:          <h2 class="h6 mb-3">Invoice Summary</h2>
135:            <dt class="col-5">Invoice #</dt>
207:                  title="Legacy Invoice PDF"

money/templates/money/invoices/legacy_file_invoice_detail.html
4:{% block title %}Legacy Invoice {{ invoice_number }}{% endblock %}
16:        Legacy Invoice {{ invoice_number }}
26:          <iframe src="{{ pdf_url }}" title="Legacy Invoice PDF" style="border: 1px solid #dee2e6;"></iframe>

money/templates/money/invoices/email_invoice_v2.txt
3:{{ brand_name }} Invoice {{ invoice.invoice_number }}
9:Invoice Number: {{ invoice.invoice_number }}

money/templates/money/invoices/invoice_add_success.html
8:    {% block title %}Invoice Added{% endblock %}
15:        <h2 class="mt-5 mb-3">Invoice Added Successfully!</h2>

money/templates/money/invoices/invoice_review_pdf.html
8:  <title>Invoice - {{ invoice.invoice_number }}</title>
33:    <h2 class="text-primary">Invoice Summary</h2>
34:    <h5 class="text-muted">{{ invoice.event.title }} Invoice</h5>
35:    <h6 class="fw-light">Invoice #: {{ invoice.invoice_number }}</h6>
38:  <!-- Invoice Info -->
40:    <div class="section-title">Invoice Information</div>
45:    <p><strong>Invoice Amount:</strong> ${{ invoice.amount|floatformat:2|intcomma }}</p>
98:          <th>Invoice</th>
125:      <p>Invoice Amount: ${{ invoice_amount|floatformat:2|intcomma }}</p>
130:      <p>Invoice Amount: ${{ invoice_amount|floatformat:2|intcomma }}</p>
134:      <p>Invoice Amount: ${{ invoice_amount|floatformat:2|intcomma }}</p>

money/templates/money/invoices/invoice_list.html
81:  <!-- Invoice table -->
87:            <th scope="col">Invoice #</th>
98:              <!-- Invoice number -->
167:        <nav aria-label="Invoice pagination">

money/templates/money/invoices/invoice_review.html
5:{% block title %}Invoice Review - #{{ invoice.invoice_number }}{% endblock %}
13:    <h2 class="text-primary mt-2">Invoice Summary</h2>
14:    <h5 class="text-muted">{{ invoice.event.title }} Invoice</h5>
15:    <h6 class="fw-light">Invoice #: {{ invoice.invoice_number }}</h6>
21:  <!-- Invoice Info -->
24:      Invoice Information
31:      <p><strong>Invoice Amount:</strong> ${{ invoice.amount|floatformat:2|intcomma }}</p>
99:              <th>Invoice</th>
132:        <p>Invoice Amount: ${{ invoice_amount|floatformat:2|intcomma }}</p>
139:        <p>Invoice Amount: ${{ invoice_amount|floatformat:2|intcomma }}</p>
148:        <p>Invoice Amount: ${{ invoice_amount|floatformat:2|intcomma }}</p>

money/templates/money/invoices/unpaid_invoices.html
12:        <th>Invoice #</th>
28:          <td><a href="{% url 'invoice_detail' invoice.id %}" class="btn btn-info btn-sm">View</a></td>

money/templates/money/invoices/invoice_v2_form.html
7:    Edit Invoice {{ invoice.invoice_number|default:"(draft)" }}
27:              Edit Invoice {{ invoice.invoice_number|default:"(draft)" }}
60:          {# Invoice number display (read-only) #}
62:            <label class="form-label">Invoice #</label>
119:            <label for="{{ form.date.id_for_label }}" class="form-label">Invoice date</label>

money/templates/money/invoices/invoice_v2_pdf.html
7:    <title>Invoice {{ invoice.invoice_number|default:"(draft)" }}</title>
133:    <!-- LEFT COLUMN: Invoice + event -->
135:      <h1 style="margin-bottom: 4px;">Invoice</h1>
167:    <!-- RIGHT COLUMN: Invoice # + date -->
170:        Invoice Number: {{ invoice.invoice_number|default:"(draft)" }}
223:      <div class="card-title">Invoice Items</div>
259:            <td><strong>Invoice Amount</strong></td>

money/templates/money/invoices/invoice_v2_detail.html
5:{% block title %}Invoice {{ invoice.invoice_number }}{% endblock %}
32:            Invoice {{ invoice.invoice_number|default:"(draft)" }}
176:          <h2 class="h6 mb-3">Invoice Summary</h2>
178:            <dt class="col-5">Invoice #</dt>
259:            <!-- Top block: Invoice, Expenses, Net income -->
261:              <span class="text-muted small">Invoice amount</span>
money/models.py
1350:class Invoice(models.Model):
money/views/invoices_legacy.py
10:from money.models import Invoice  # legacy Invoice model

money/management/commands/migrate_legacy_invoices.py
8:from money.models import Invoice, InvoiceV2, InvoiceItemV2
money/views/invoices_legacy.py
1:# money/views/invoices_legacy.py
10:from money.models import Invoice  # legacy Invoice model
15:    Read-only detail page for legacy invoices stored in the old Invoice model.
17:    URL name:  money:legacy_invoice_detail
18:    Template:  money/invoices/legacy_invoice_detail.html
20:    template_name = "money/invoices/legacy_invoice_detail.html"
23:        legacy = get_object_or_404(
28:        issue_date = getattr(legacy, "issue_date", None) or getattr(legacy, "date", None)
29:        total_amount = getattr(legacy, "total_amount", None) or getattr(legacy, "amount", None)
33:            "invoice": legacy,
34:            "legacy_issue_date": issue_date,
35:            "legacy_total_amount": total_amount,
36:            "legacy_pdf_url": pdf_url,
43:    Read-only detail page for legacy *PDF-only* invoices that do not
46:    URL name:  money:legacy_file_invoice_detail
47:    Template:  money/invoices/legacy_file_invoice_detail.html
49:    template_name = "money/invoices/legacy_file_invoice_detail.html"
52:        legacy_dir = getattr(settings, "LEGACY_INVOICE_DIR", "legacy_invoices/")
54:        if not filename.startswith(legacy_dir):
55:            raise Http404("Invalid legacy invoice path")

money/views/invoices_unified.py
14:    load_legacy_files,
15:    load_legacy_model_invoices,
37:        rows.extend(load_legacy_model_invoices(request))  # must scope internally
38:        rows.extend(load_legacy_files(request))           # must scope internally

money/urls.py
22:# Invoices (Unified + legacy detail routes)
24:from .views.invoices_legacy import LegacyInvoiceDetailView, LegacyFileInvoiceDetailView
133:    # Invoices (Unified list: v2 + legacy rows together)
155:    path("invoices/legacy/<int:pk>/", LegacyInvoiceDetailView.as_view(), name="legacy_invoice_detail"),
156:    path("invoices/legacy/file/<path:filename>/", LegacyFileInvoiceDetailView.as_view(), name="legacy_file_invoice_detail"),

money/unified_invoices.py
38:        'legacy_model' -> legacy Invoice instance in the DB
39:        'legacy_file'  -> PDF-only legacy invoice on storage
43:    id: str  # e.g. "v2-9", "legacy-12", "file-250101"
66:    def is_legacy_model(self) -> bool:
67:        return self.kind == "legacy_model"
70:    def is_legacy_file(self) -> bool:
71:        return self.kind == "legacy_file"
180:def load_legacy_model_invoices(request) -> List[UnifiedInvoiceRow]:
225:        # Existing legacy detail view (keep it)
227:            detail_url = reverse("money:legacy_invoice_detail", args=[inv.pk])
231:        # âœ… IMPORTANT: legacy review view (this is what you want back)
239:                kind="legacy_model",
240:                id=f"legacy-{inv.pk}",
267:def load_legacy_files(request) -> List[UnifiedInvoiceRow]:
274:        LEGACY_INVOICE_DIR = "legacy_invoices/"
276:    legacy_dir = getattr(settings, "LEGACY_INVOICE_DIR", "legacy_invoices/")
281:        _, file_list = default_storage.listdir(legacy_dir)
289:        path = f"{legacy_dir}{filename}"
303:                "money:legacy_file_invoice_detail",
311:                kind="legacy_file",

money/context_processors.py
37:        "COMPANY_PROFILE": profile,          # optional legacy alias

money/models.py
1352:    Deprecated legacy Invoice.
1357:    client = models.ForeignKey("Client", on_delete=models.PROTECT, related_name="legacy_invoices")
1360:    event = models.ForeignKey("Event", on_delete=models.PROTECT, related_name="legacy_invoices")
1361:    service = models.ForeignKey("Service", on_delete=models.PROTECT, related_name="legacy_invoices")

money/management/commands/migrate_legacy_invoices.py
16:def _legacy_or_default(value, default):
39:    help = "Migrate legacy Invoice + InvoiceItem records into InvoiceV2."
67:        self.stdout.write(self.style.NOTICE(f"Found {qs.count()} legacy invoices"))
71:        for legacy in qs:
72:            self.stdout.write(f"â†’ Migrating invoice {legacy.invoice_number}")
78:                migrated += self._migrate_one_invoice(legacy)
86:    def _migrate_one_invoice(self, legacy: Invoice) -> int:
88:        Migrate a single legacy invoice + its items into InvoiceV2.
91:        user = legacy.client.user
96:            invoice_number=legacy.invoice_number,
100:                    f"  Skipping {legacy.invoice_number} (already migrated)"
110:            invoice_number=legacy.invoice_number,
111:            client=legacy.client,
112:            event=legacy.event,
113:            event_name=legacy.event_name,
114:            location=legacy.location,
115:            service=legacy.service,
116:            date=legacy.date,
117:            due=legacy.due,
118:            paid_date=legacy.paid_date,
119:            status=legacy.status,
120:            issued_at=legacy.issued_at,
121:            version=_legacy_or_default(legacy.version, 1),
124:            from_name=legacy.from_name or "",
125:            from_address=legacy.from_address or "",
126:            from_phone=legacy.from_phone or "",
127:            from_email=legacy.from_email or "",
128:            from_website=legacy.from_website or "",
129:            from_tax_id=legacy.from_tax_id or "",
131:            from_logo_url=legacy.from_logo_url or "",
132:            from_header_logo_max_width_px=_legacy_or_default(
133:                legacy.from_header_logo_max_width_px, 320
136:            from_terms=legacy.from_terms or "",
137:            from_net_days=_legacy_or_default(legacy.from_net_days, 30),
138:            from_footer_text=legacy.from_footer_text or "",
140:            from_currency=_legacy_or_default(legacy.from_currency, "USD"),
141:            from_locale=_legacy_or_default(legacy.from_locale, "en_US"),
142:            from_timezone=_legacy_or_default(
143:                legacy.from_timezone, "America/Indiana/Indianapolis"
150:        legacy_items = list(legacy.items.all())
152:        if not legacy_items and legacy.amount and legacy.amount != Decimal("0.00"):
159:                price=legacy.amount,
164:            for item in legacy_items:
180:        if invoice_v2.amount != legacy.amount:
182:                f"Amount mismatch for invoice {legacy.invoice_number}: "
183:                f"{legacy.amount} != {invoice_v2.amount}"

money/migrations/0017_alter_client_options_alter_service_options_and_more.py
211:            field=models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='legacy_invoices', to='money.client'),
216:            field=models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='legacy_invoices', to='money.event'),
221:            field=models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='legacy_invoices', to='money.service'),

money/templates/money/invoices/legacy_invoice_detail.html
39:              {% if legacy_issue_date %}
40:                {{ legacy_issue_date|date:"M j, Y" }}
66:          {% if legacy_pdf_url %}
67:            <a href="{{ legacy_pdf_url }}"
184:              {% if legacy_total_amount %}
185:                ${{ legacy_total_amount|floatformat:2 }}
200:  <!-- Optional legacy PDF embed -->
201:  {% if legacy_pdf_url %}
206:          <iframe src="{{ legacy_pdf_url }}"
210:        <a href="{{ legacy_pdf_url }}" target="_blank"