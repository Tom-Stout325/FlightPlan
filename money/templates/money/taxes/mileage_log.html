{% extends "index.html" %}
{% load humanize %}

{% block title %}Mileage Log{% endblock %}


{% block extra_css %}
<style>
  .metric-pill {
    background: #e9f4ff;
    border-radius: 14px;
    padding: 14px 10px;
    height: 100%;
    transition: background-color 0.15s ease, transform 0.15s ease;
  }

  .metric-pill:hover {
    background: #eef2f7;
  }

  .metric-label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    margin-bottom: 4px;
  }

  .metric-value {
    font-size: 1.05rem;
    font-weight: 600;
    color: #212529;
  }
</style>
{% endblock %}
{% block content %}

<div class="container bg-light border rounded p-4">

  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-3 mb-3">
    <div>
      <h2 class="text-primary mb-1">Mileage Log</h2>
      <div class="text-muted small">Filter by year and vehicle.</div>
    </div>

    <div class="d-flex flex-wrap gap-2">
      <a href="{% url 'money:vehicle_list' %}" class="btn btn-outline-primary btn-sm">
        Manage Vehicles
      </a>
      <a href="{% url 'money:vehicle_add' %}" class="btn btn-outline-success btn-sm">
        + Add Vehicle
      </a>
      <a href="{% url 'money:mileage_report_pdf' %}?year={{ selected_year }}{% if vehicle %}&vehicle={{ vehicle.pk }}{% endif %}"
        target="_blank" class="btn btn-outline-danger btn-sm px-5">
        IRS PDF
      </a>
    </div>
  </div>

  <!-- Filters -->
  <form method="get" class="card mb-4 shadow-sm">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-12 col-md-3">
          <label class="form-label">Tax Year</label>
          <select name="year" class="form-select" onchange="this.form.submit()">
            {% for y in year_choices %}
              <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Vehicle</label>
          <select name="vehicle" class="form-select" onchange="this.form.submit()">
            <option value="">All Vehicles</option>
            {% for v in vehicle_choices %}
              <option value="{{ v.id }}" {% if v.id == selected_vehicle_id %}selected{% endif %}>
                {{ v.name }}{% if not v.is_active %} (inactive){% endif %}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-3 mb-3">
          <a href="{% url 'money:mileage_log' %}" class="btn btn-outline-secondary w-100">
            Clear Filters
          </a>
        </div>
      </div>
    </div>
  </form>

<div class="card mb-4">
  <div class="card-body text-center">
    <h5 class="card-title mb-1">Summary ({{ selected_year }})</h5>
    <div class="text-muted small mb-3">
      Mileage Rate: ${{ mileage_rate|floatformat:2 }} / mile
    </div>

    <!-- Row 1 -->
    <div class="row justify-content-center mb-3">
      <div class="col-12 col-md-10">
        <div class="row g-3">
          <div class="col-6 col-md-3">
            <div class="metric-pill">
              <div class="metric-label">Business Miles</div>
              <div class="metric-value">{{ business_miles|floatformat:1|intcomma }}</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="metric-pill">
              <div class="metric-label">Business Amount</div>
              <div class="metric-value">${{ business_amount|floatformat:2|intcomma }}</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="metric-pill">
              <div class="metric-label">Commuting Miles</div>
              <div class="metric-value">{{ commuting_miles|floatformat:1|intcomma }}</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="metric-pill">
              <div class="metric-label">Commuting Amount</div>
              <div class="metric-value">${{ commuting_amount|floatformat:2|intcomma }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <hr class="w-75 mx-auto">

    <!-- Row 2 -->
    <div class="row justify-content-center mt-3">
      <div class="col-12 col-md-10">
        <div class="row g-3">
          <div class="col-6 col-md-3">
            <div class="metric-pill">
              <div class="metric-label">Other Miles</div>
              <div class="metric-value">{{ other_miles|floatformat:1|intcomma }}</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="metric-pill">
              <div class="metric-label">Other Amount</div>
              <div class="metric-value">${{ other_amount|floatformat:2|intcomma }}</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="metric-pill">
              <div class="metric-label">Reimbursed Miles</div>
              <div class="metric-value">{{ reimbursed_miles|floatformat:1|intcomma }}</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="metric-pill">
              <div class="metric-label">Reimbursed Amount</div>
              <div class="metric-value">${{ reimbursed_amount|floatformat:2|intcomma }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>




  <!-- Mileage Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-primary">
        <tr>
          <th>Date</th>
          <th class="d-none d-md-table-cell">Vehicle</th>
          <th class="d-none d-md-table-cell">Client</th>
          <th class="d-none d-md-table-cell">Invoice #</th>
          <th class="d-none d-md-table-cell">Job</th>
          <th class="d-none d-md-table-cell text-end">Begin</th>
          <th class="d-none d-md-table-cell text-end">End</th>
          <th class="text-end">Total Miles</th>
          <th class="text-end">Amount</th>
          <th class="text-center">Type</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for entry in mileage_list %}
          <tr>
            <td class="text-nowrap">{{ entry.date|date:"n/d/y" }}</td>

            <td class="d-none d-md-table-cell">
              {{ entry.vehicle.name|default:"—" }}
            </td>

            <td class="d-none d-md-table-cell">{{ entry.client|default:"—" }}</td>

            <td class="d-none d-md-table-cell">
              {% if entry.invoice_v2 %}
                {{ entry.invoice_v2.invoice_number }}
              {% else %}
                {{ entry.invoice_number|default:"—" }}
              {% endif %}
            </td>

            <td class="d-none d-md-table-cell">{{ entry.event|default:"—" }}</td>

            <td class="d-none d-md-table-cell text-end">{{ entry.begin|floatformat:1|intcomma }}</td>
            <td class="d-none d-md-table-cell text-end">{{ entry.end|floatformat:1|intcomma }}</td>

            <td class="text-end">{{ entry.miles|floatformat:1|intcomma }}</td>
            <td class="text-end">${{ entry.amount|floatformat:2|intcomma }}</td>
            <td class="text-center">{{ entry.mileage_type}}</td>

            <td class="text-end text-nowrap">
              <a href="{% url 'money:mileage_update' entry.pk %}"
                 class="btn btn-sm btn-outline-primary me-1"
                 title="Edit" aria-label="Edit">
                <i class="fa-solid fa-pen-to-square"></i>
              </a>
              <a href="{% url 'money:mileage_delete' entry.pk %}"
                 class="btn btn-sm btn-outline-danger"
                 title="Delete" aria-label="Delete"
                 onclick="return confirm('Are you sure you want to delete this mileage entry?');">
                <i class="fa-solid fa-trash"></i>
              </a>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="11" class="text-center">
              No mileage entries found for {{ selected_year }}.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-3">
    <div class="mileage-actions d-flex flex-wrap gap-2 justify-content-center justify-content-md-end">
      <a href="{% url 'money:mileage_create' %}" class="btn btn-primary">
        + Add Mileage Entry
      </a>
      <a href="{% url 'money:update_mileage_rate' %}?year={{ selected_year }}" class="btn btn-secondary">
        Update Mileage Rate
      </a>
      <a href="{% url 'money:export_mileage_csv' %}?year={{ selected_year }}{% if selected_vehicle_id %}&vehicle={{ selected_vehicle_id }}{% endif %}" class="btn btn-success px-4">
        Download CSV
      </a>
    </div>
  </div>

  <!-- Pagination (preserve filters) -->
  {% if page_obj.has_previous or page_obj.has_next %}
    <nav aria-label="Page navigation" class="mt-4">
      <ul class="pagination justify-content-center flex-wrap">

        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ page_obj.previous_page_number }}&year={{ selected_year }}{% if selected_vehicle_id %}&vehicle={{ selected_vehicle_id }}{% endif %}">
              Previous
            </a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}

        <li class="page-item disabled">
          <span class="page-link">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
          </span>
        </li>

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ page_obj.next_page_number }}&year={{ selected_year }}{% if selected_vehicle_id %}&vehicle={{ selected_vehicle_id }}{% endif %}">
              Next
            </a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

</div>
{% endblock %}
