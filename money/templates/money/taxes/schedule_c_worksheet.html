{% extends "index.html" %}
{% load static %}
{% load humanize %}

{% block title %}Schedule C Worksheet{% endblock %}

{% block content %}
<div class="container my-4" style="max-width: 1000px;">
  <h1 class="h3 mb-3 text-center">Schedule C Worksheet</h1>

  <!-- SINGLE FORM WRAPPING ENTIRE WORKSHEET -->
  <form method="post">
    {% csrf_token %}

    <!-- YEAR SELECTION + ACTIONS -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="row gy-3 gx-3 align-items-center">

          <!-- Year select -->
          <div class="col-12 col-md-4">
            <label for="year" class="form-label fw-semibold">Tax Year</label>
            <select name="year" id="year" class="form-select" onchange="this.form.submit()">
              {% for year in available_years %}
                <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>
                  {{ year }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- Action buttons -->
          <div class="col-12 col-md-auto ms-md-auto text-md-end">
            <!-- Recalculate (posts to same view) -->
            <button type="submit"
                    name="action"
                    value="recalc"
                    class="btn btn-dark mt-2 mt-md-4">
              <i class="fa-solid fa-rotate"></i> Recalculate
            </button>

            <!-- Preview PDF (POST full form to PDF view, new tab) -->
            <button type="submit"
                    name="action"
                    value="preview"
                    class="btn btn-outline-secondary mt-2 mt-md-4 ms-md-2"
                    formaction="{% url 'money:schedule_c_pdf' selected_year %}?preview=1"
                    formmethod="post"
                    formtarget="_blank">
              <i class="fa-solid fa-eye"></i> Preview PDF
            </button>

            <!-- Download PDF (POST full form to PDF view, new tab) -->
            <button type="submit"
                    name="action"
                    value="download"
                    class="btn btn-outline-danger mt-2 mt-md-4 ms-md-2"
                    formaction="{% url 'money:schedule_c_pdf' selected_year %}"
                    formmethod="post"
                    formtarget="_blank">
              <i class="fa-solid fa-file-pdf"></i> Download PDF
            </button>
          </div>

        </div>
      </div>
    </div>

    <!-- PART I – INCOME -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-primary text-white">
        <strong>Part I – Income</strong>
      </div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0 align-middle">
          <thead class="table-light d-none d-md-table-header-group">
            <tr>
              <th style="width: 10%">Line</th>
              <th style="width: 55%">Description</th>
              <th class="text-end" style="width: 35%">Amount</th>
            </tr>
          </thead>
          <tbody>
            <!-- Line 1 -->
            <tr>
              <td><strong>1</strong></td>
              <td>Gross receipts or sales</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end"
                       value="{{ schedule.line_1|floatformat:2|intcomma }}">
              </td>
            </tr>

            <!-- Line 2 (manual) -->
            <tr>
              <td><strong>2</strong></td>
              <td><strong>Returns and allowances (manual)</strong></td>
              <td class="text-end">
                <input type="number" step="0.01" name="line_2"
                       class="form-control form-control-sm text-end"
                       value="{{ schedule.line_2 }}">
              </td>
            </tr>

            <!-- Line 3 -->
            <tr>
              <td><strong>3</strong></td>
              <td class="text-muted">Gross income after returns (line 1 minus line 2)</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end fw-bold"
                       value="{{ schedule.line_3|floatformat:2|intcomma }}">
              </td>
            </tr>

            <!-- Line 4 -->
            <tr>
              <td><strong>4</strong></td>
              <td>Cost of goods sold</td>
              <td class="text-end">
                <input type="number"
                       step="0.01"
                       id="id_line_4"
                       readonly
                       name="line_4"
                       class="form-control form-control-sm text-end"
                       value="{{ schedule.line_4|default_if_none:'' }}">
              </td>
            </tr>

            <!-- Line 5 -->
            <tr>
              <td><strong>5</strong></td>
              <td class="text-muted">Gross profit (line 3 minus line 4)</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end fw-bold"
                       value="{{ schedule.line_5|floatformat:2|intcomma }}">
              </td>
            </tr>

            <!-- Line 6 (manual) -->
            <tr>
              <td><strong>6</strong></td>
              <td>Other income (manual)</td>
              <td class="text-end">
                <input type="number" step="0.01" name="line_6"
                       class="form-control form-control-sm text-end"
                       value="{{ schedule.line_6 }}">
              </td>
            </tr>

            <!-- Line 7 -->
            <tr>
              <td><strong>7</strong></td>
              <td class="text-muted">Gross income (line 5 plus line 6)</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end"
                       value="{{ schedule.line_7|floatformat:2|intcomma }}">
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- PART II – EXPENSES -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-danger text-white">
        <strong>Part II – Expenses</strong>
      </div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0 align-middle">
          <thead class="table-light d-none d-md-table-header-group">
            <tr>
              <th style="width: 10%">Line</th>
              <th style="width: 55%">Description</th>
              <th class="text-end" style="width: 35%">Amount</th>
            </tr>
          </thead>
          <tbody>
            <!-- 8 Advertising -->
            <tr>
              <td><strong>8</strong></td>
              <td>Advertising</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end"
                       value="{{ schedule.line_8|floatformat:2|intcomma }}">
              </td>
            </tr>

            <!-- 9 Car & truck (mileage) -->
            <tr>
              <td><strong>9</strong></td>
              <td>Car and truck expenses (mileage dollars)</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end"
                       value="{{ schedule.line_9|floatformat:2|intcomma }}">
              </td>
            </tr>

            <!-- 10–11 -->
            <tr>
              <td><strong>10</strong></td>
              <td>Commissions and fees</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end"
                       value="{{ schedule.line_10|floatformat:2|intcomma }}">
              </td>
            </tr>
            <tr>
              <td><strong>11</strong></td>
              <td>Contract labor</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end"
                       value="{{ schedule.line_11|floatformat:2|intcomma }}">
              </td>
            </tr>

            <!-- 12–14 manual -->
            <tr>
              <td><strong>12</strong></td>
              <td>Depletion (manual)</td>
              <td class="text-end">
                <input type="number" step="0.01" name="line_12"
                       class="form-control form-control-sm text-end"
                       value="{{ schedule.line_12 }}">
              </td>
            </tr>
            <tr>
              <td><strong>13</strong></td>
              <td>Depreciation and section 179 (manual)</td>
              <td class="text-end">
                <input type="number" step="0.01" name="line_13"
                       class="form-control form-control-sm text-end"
                       value="{{ schedule.line_13 }}">
              </td>
            </tr>
            <tr>
              <td><strong>14</strong></td>
              <td>Employee benefit programs (manual)</td>
              <td class="text-end">
                <input type="number" step="0.01" name="line_14"
                       class="form-control form-control-sm text-end"
                       value="{{ schedule.line_14 }}">
              </td>
            </tr>

            <!-- 15 Insurance -->
            <tr>
              <td><strong>15</strong></td>
              <td>Insurance (other than health)</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end"
                       value="{{ schedule.line_15|floatformat:2|intcomma }}">
              </td>
            </tr>

            <!-- 16a/b manual -->
            <tr>
              <td><strong>16a</strong></td>
              <td>Mortgage interest (manual)</td>
              <td class="text-end">
                <input type="number" step="0.01" name="line_16a"
                       class="form-control form-control-sm text-end"
                       value="{{ schedule.line_16a }}">
              </td>
            </tr>
            <tr>
              <td><strong>16b</strong></td>
              <td>Other interest (manual)</td>
              <td class="text-end">
                <input type="number" step="0.01" name="line_16b"
                       class="form-control form-control-sm text-end"
                       value="{{ schedule.line_16b }}">
              </td>
            </tr>

            <!-- 17–18 -->
            <tr>
              <td><strong>17</strong></td>
              <td>Legal and professional services</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end"
                       value="{{ schedule.line_17|floatformat:2|intcomma }}">
              </td>
            </tr>
            <tr>
              <td><strong>18</strong></td>
              <td>Office expense</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end"
                       value="{{ schedule.line_18|floatformat:2|intcomma }}">
              </td>
            </tr>

            <!-- 19 manual -->
            <tr>
              <td><strong>19</strong></td>
              <td>Pension and profit-sharing plans (manual)</td>
              <td class="text-end">
                <input type="number" step="0.01" name="line_19"
                       class="form-control form-control-sm text-end"
                       value="{{ schedule.line_19 }}">
              </td>
            </tr>

            <!-- 20a/b -->
            <tr>
              <td><strong>20a</strong></td>
              <td>Rent or lease – vehicles, machinery, equipment</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end"
                       value="{{ schedule.line_20a|floatformat:2|intcomma }}">
              </td>
            </tr>
            <tr>
              <td><strong>20b</strong></td>
              <td>Rent or lease – other business property</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end"
                       value="{{ schedule.line_20b|floatformat:2|intcomma }}">
              </td>
            </tr>

            <!-- 21–23 -->
            <tr>
              <td><strong>21</strong></td>
              <td>Repairs and maintenance</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end"
                       value="{{ schedule.line_21|floatformat:2|intcomma }}">
              </td>
            </tr>
            <tr>
              <td><strong>22</strong></td>
              <td>Supplies</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end"
                       value="{{ schedule.line_22|floatformat:2|intcomma }}">
              </td>
            </tr>
            <tr>
              <td><strong>23</strong></td>
              <td>Taxes and licenses</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end"
                       value="{{ schedule.line_23|floatformat:2|intcomma }}">
              </td>
            </tr>

            <!-- 24 Travel + Meals -->
            <tr>
              <td><strong>24a</strong></td>
              <td>Travel</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end"
                       value="{{ schedule.line_24a|floatformat:2|intcomma }}">
              </td>
            </tr>
            <tr>
              <td><strong>24b</strong></td>
              <td>Deductible meals (already 50%)</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end"
                       value="{{ schedule.line_24b|floatformat:2|intcomma }}">
              </td>
            </tr>

            <!-- 25–26 -->
            <tr>
              <td><strong>25</strong></td>
              <td>Utilities</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end"
                       value="{{ schedule.line_25|floatformat:2|intcomma }}">
              </td>
            </tr>
            <tr>
              <td><strong>26</strong></td>
              <td>Wages</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end"
                       value="{{ schedule.line_26|floatformat:2|intcomma }}">
              </td>
            </tr>

            <!-- 27a and 27b -->
            <tr>
              <td><strong>27a</strong></td>
              <td>Other expenses (from Part V)</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end fw-semibold"
                       value="{{ schedule.line_27a|floatformat:2|intcomma }}">
              </td>
            </tr>
            <tr>
              <td><strong>27b</strong></td>
              <td>Reserved / other (manual)</td>
              <td class="text-end">
                <input type="number" step="0.01" name="line_27b"
                       class="form-control form-control-sm text-end"
                       value="{{ schedule.line_27b }}">
              </td>
            </tr>

            <!-- 28 Total expenses -->
            <tr class="table-light">
              <td><strong>28</strong></td>
              <td><strong>Total expenses</strong></td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end fw-bold"
                       value="{{ schedule.line_28|floatformat:2|intcomma }}">
              </td>
            </tr>

            <!-- 29–31 -->
            <tr>
              <td><strong>29</strong></td>
              <td>Tentative profit (loss) (line 7 minus line 28)</td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end"
                       value="{{ schedule.line_29|floatformat:2|intcomma }}">
              </td>
            </tr>
            <tr>
              <td><strong>30</strong></td>
              <td>Business use of home (manual)</td>
              <td class="text-end">
                <input type="number" step="0.01" name="line_30"
                       class="form-control form-control-sm text-end"
                       value="{{ schedule.line_30 }}">
              </td>
            </tr>
            <tr class="table-light">
              <td><strong>31</strong></td>
              <td><strong>Net profit (loss) (line 29 minus line 30)</strong></td>
              <td class="text-end">
                <input type="text" readonly class="form-control form-control-sm text-end fw-bold"
                       value="{{ schedule.line_31|floatformat:2|intcomma }}">
              </td>
            </tr>

          </tbody>
        </table>
      </div>
    </div>

    <!-- LINE 32 – Investment at risk (HTML view) -->
    <div class="border border-dark border-top-0 p-2 mt-0 mb-4">
      <div class="row g-2 align-items-start">
        <!-- Line number -->
        <div class="col-1 col-sm-1 fw-bold pt-1">
          32
        </div>

        <!-- Narrative text -->
        <div class="col-12 col-md-7 small">
          If you have a loss, check the box that describes your investment in this activity.
          See instructions.
          <br><br>
          • If you checked <b>32a</b>, enter the loss on both
          <b>Schedule 1 (Form 1040), line 3</b>, and on
          <b>Schedule SE, line 2</b>. (If you checked the box on line 1, see the line 31
          instructions.) Estates and trusts, enter on <b>Form 1041, line 3</b>.
          <br>
          • If you checked <b>32b</b>, you <b>must attach Form 6198</b>. Your loss may be limited.
        </div>

        <!-- Radios -->
        <div class="col-12 col-md-4">
          <div class="form-check mb-1">
            <input
              class="form-check-input"
              type="radio"
              name="line_32"
              id="line32a"
              value="32a"
              {% if schedule.line_32 == "32a" %}checked{% endif %}
            >
            <label class="form-check-label small" for="line32a">
              32a All investment is at risk
            </label>
          </div>

          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="line_32"
              id="line32b"
              value="32b"
              {% if schedule.line_32 == "32b" %}checked{% endif %}
            >
            <label class="form-check-label small" for="line32b">
              32b Some investment is not at risk
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- PART III – COST OF GOODS SOLD (HTML FORM) -->
    <div class="card mb-5">
      <div class="card-header fw-bold bg-success text-white">
        Part III – Cost of Goods Sold <span class="small text-white">(see instructions)</span>
      </div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th style="width: 8%;">Ln</th>
              <th>Description</th>
              <th class="text-end" style="width: 20%;">Amount</th>
            </tr>
          </thead>
          <tbody>
            <!-- 33 -->
            <tr>
              <td><strong>33</strong></td>
              <td>
                <div class="small">
                  Method(s) used to value closing inventory:
                </div>
                <div class="small mt-1">
                  <label class="me-3">
                    <input type="checkbox" name="line_33_cost"
                           {% if schedule.line_33_cost %}checked{% endif %}> a&nbsp;Cost
                  </label>
                  <label class="me-3">
                    <input type="checkbox" name="line_33_lcm"
                           {% if schedule.line_33_lcm %}checked{% endif %}> b&nbsp;Lower of cost or market
                  </label>
                  <label>
                    <input type="checkbox" name="line_33_other"
                           {% if schedule.line_33_other %}checked{% endif %}> c&nbsp;Other (attach explanation)
                  </label>
                </div>
              </td>
              <td></td>
            </tr>

            <!-- 34 -->
            <tr>
              <td><strong>34</strong></td>
              <td>
                <div class="small">
                  Was there any change in determining quantities, costs, or valuations between
                  opening and closing inventory? If “Yes”, attach explanation.
                </div>
              </td>
              <td class="text-end">
                <div class="d-flex justify-content-end gap-3 small">
                  <label class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="radio" name="line_34_change"
                           value="yes"
                           {% if schedule.line_34_change == "yes" %}checked{% endif %}>
                    <span class="form-check-label">Yes</span>
                  </label>
                  <label class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="radio" name="line_34_change"
                           value="no"
                           {% if schedule.line_34_change == "no" %}checked{% endif %}>
                    <span class="form-check-label">No</span>
                  </label>
                </div>
              </td>
            </tr>

            <!-- 35 -->
            <tr>
              <td><strong>35</strong></td>
              <td>Inventory at beginning of year</td>
              <td>
                <input type="number" step="0.01" class="form-control form-control-sm text-end line35-41"
                       id="id_line_35" name="line_35"
                       value="{{ schedule.line_35|default_if_none:'' }}">
              </td>
            </tr>

            <!-- 36 -->
            <tr>
              <td><strong>36</strong></td>
              <td>Purchases less cost of items withdrawn for personal use</td>
              <td>
                <input type="number" step="0.01" class="form-control form-control-sm text-end line35-41"
                       id="id_line_36" name="line_36"
                       value="{{ schedule.line_36|default_if_none:'' }}">
              </td>
            </tr>

            <!-- 37 -->
            <tr>
              <td><strong>37</strong></td>
              <td>Cost of labor (do not include any amounts paid to yourself)</td>
              <td>
                <input type="number" step="0.01" class="form-control form-control-sm text-end line35-41"
                       id="id_line_37" name="line_37"
                       value="{{ schedule.line_37|default_if_none:'' }}">
              </td>
            </tr>

            <!-- 38 -->
            <tr>
              <td><strong>38</strong></td>
              <td>Materials and supplies</td>
              <td>
                <input type="number" step="0.01" class="form-control form-control-sm text-end line35-41"
                       id="id_line_38" name="line_38"
                       value="{{ schedule.line_38|default_if_none:'' }}">
              </td>
            </tr>

            <!-- 39 -->
            <tr>
              <td><strong>39</strong></td>
              <td>Other costs</td>
              <td>
                <input type="number" step="0.01" class="form-control form-control-sm text-end line35-41"
                       id="id_line_39" name="line_39"
                       value="{{ schedule.line_39|default_if_none:'' }}">
              </td>
            </tr>

            <!-- 40 = 35–39 total (auto) -->
            <tr>
              <td><strong>40</strong></td>
              <td>Add lines 35 through 39</td>
              <td>
                <input type="number" step="0.01" class="form-control form-control-sm text-end"
                       id="id_line_40" name="line_40"
                       value="{{ schedule.line_40|default_if_none:'' }}" readonly>
              </td>
            </tr>

            <!-- 41 -->
            <tr>
              <td><strong>41</strong></td>
              <td>Inventory at end of year</td>
              <td>
                <input type="number" step="0.01" class="form-control form-control-sm text-end line35-41"
                       id="id_line_41" name="line_41"
                       value="{{ schedule.line_41|default_if_none:'' }}">
              </td>
            </tr>

            <!-- 42 = 40 - 41 (auto, also feeds line 4) -->
            <tr>
              <td><strong>42</strong></td>
              <td>Cost of goods sold. Subtract line 41 from line 40.</td>
              <td>
                <input type="number" step="0.01" class="form-control form-control-sm text-end"
                       id="id_line_42" name="line_42"
                       value="{{ schedule.line_42|default_if_none:'' }}" readonly>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- PART IV – INFORMATION ON YOUR VEHICLE -->
    <div class="card mt-4">
      <div class="card-header bg-warning fw-bold">
        Part IV – Information on Your Vehicle
        <span class="small text-muted">
          &nbsp;Complete this part only if you are claiming car or truck expenses on line 9
          and are not required to file Form 4562.
        </span>
      </div>

      <div class="card-body p-0">
        <table class="table table-sm mb-0">
          <tbody>

            <!-- 43 -->
            <tr>
              <td style="width: 8%;"><strong>43</strong></td>
              <td>
                <div class="small">
                  When did you place your vehicle in service for business purposes?
                  (month/day/year)
                </div>
              </td>
              <td style="width: 28%;" class="text-end">
                <input type="date"
                       class="form-control form-control-sm"
                       id="id_line_43"
                       name="line_43"
                       value="{{ schedule.line_43|default_if_none:'' }}">
              </td>
            </tr>

            <!-- 44 -->
            <tr>
              <td><strong>44</strong></td>
              <td>
                <div class="small mb-1">
                  Of the total number of miles you drove your vehicle during {{ selected_year }},
                  enter the number of miles you used your vehicle for:
                </div>
                <div class="small">
                  <label class="me-3">
                    a&nbsp;Business&nbsp;
                    <input type="number" step="1" min="0"
                           class="form-control form-control-sm d-inline-block text-end"
                           style="width: 110px;"
                           id="id_line_44a"
                           name="line_44a"
                           value="{{ schedule.line_44a|default_if_none:'' }}">
                  </label>

                  <label class="me-3">
                    b&nbsp;Commuting&nbsp;
                    <input type="number" step="1" min="0"
                           class="form-control form-control-sm d-inline-block text-end"
                           style="width: 110px;"
                           id="id_line_44b"
                           name="line_44b"
                           value="{{ schedule.line_44b|default_if_none:'' }}">
                  </label>

                  <label>
                    c&nbsp;Other&nbsp;
                    <input type="number" step="1" min="0"
                           class="form-control form-control-sm d-inline-block text-end"
                           style="width: 110px;"
                           id="id_line_44c"
                           name="line_44c"
                           value="{{ schedule.line_44c|default_if_none:'' }}">
                  </label>
                </div>
              </td>
              <td></td>
            </tr>

            <!-- 45 -->
            <tr>
              <td><strong>45</strong></td>
              <td>
                <div class="small">
                  Was your vehicle available for personal use during off-duty hours?
                </div>
              </td>
              <td class="text-end">
                <div class="d-flex justify-content-end gap-3 small">
                  <label class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="radio"
                           name="line_45" value="yes"
                           {% if schedule.line_45 == "yes" %}checked{% endif %}>
                    <span class="form-check-label">Yes</span>
                  </label>
                  <label class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="radio"
                           name="line_45" value="no"
                           {% if schedule.line_45 == "no" %}checked{% endif %}>
                    <span class="form-check-label">No</span>
                  </label>
                </div>
              </td>
            </tr>

            <!-- 46 -->
            <tr>
              <td><strong>46</strong></td>
              <td>
                <div class="small">
                  Do you (or your spouse) have another vehicle available for personal use?
                </div>
              </td>
              <td class="text-end">
                <div class="d-flex justify-content-end gap-3 small">
                  <label class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="radio"
                           name="line_46" value="yes"
                           {% if schedule.line_46 == "yes" %}checked{% endif %}>
                    <span class="form-check-label">Yes</span>
                  </label>
                  <label class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="radio"
                           name="line_46" value="no"
                           {% if schedule.line_46 == "no" %}checked{% endif %}>
                    <span class="form-check-label">No</span>
                  </label>
                </div>
              </td>
            </tr>

            <!-- 47a -->
            <tr>
              <td><strong>47a</strong></td>
              <td>
                <div class="small">
                  Do you have evidence to support your deduction?
                </div>
              </td>
              <td class="text-end">
                <div class="d-flex justify-content-end gap-3 small">
                  <label class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="radio"
                           name="line_47a" value="yes"
                           {% if schedule.line_47a == "yes" %}checked{% endif %}>
                    <span class="form-check-label">Yes</span>
                  </label>
                  <label class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="radio"
                           name="line_47a" value="no"
                           {% if schedule.line_47a == "no" %}checked{% endif %}>
                    <span class="form-check-label">No</span>
                  </label>
                </div>
              </td>
            </tr>

            <!-- 47b -->
            <tr>
              <td><strong>47b</strong></td>
              <td>
                <div class="small">
                  If “Yes”, is the evidence written?
                </div>
              </td>
              <td class="text-end">
                <div class="d-flex justify-content-end gap-3 small">
                  <label class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="radio"
                           name="line_47b" value="yes"
                           {% if schedule.line_47b == "yes" %}checked{% endif %}>
                    <span class="form-check-label">Yes</span>
                  </label>
                  <label class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="radio"
                           name="line_47b" value="no"
                           {% if schedule.line_47b == "no" %}checked{% endif %}>
                    <span class="form-check-label">No</span>
                  </label>
                </div>
              </td>
            </tr>

          </tbody>
        </table>
      </div>
    </div>

    <!-- PART V – OTHER EXPENSES DETAIL -->
    <div class="card shadow-sm mb-5 mt-4">
      <div class="card-header bg-secondary text-white">
        <strong>Part V – Other Expenses Detail</strong>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 10%">#</th>
                <th style="width: 60%">Description (SubCategory)</th>
                <th class="text-end" style="width: 30%">Total</th>
              </tr>
            </thead>
            <tbody>
              {% if schedule.part_v_rows %}
                {% for row in schedule.part_v_rows %}
                  <tr>
                    <td class="text-center">{{ forloop.counter }}</td>
                    <td>{{ row.name }}</td>
                    <td class="text-end">
                      {{ row.total|floatformat:2|intcomma }}
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="3" class="text-center text-muted py-3">
                    No “Other expenses” recorded for this year.
                  </td>
                </tr>
              {% endif %}
            </tbody>
            <tfoot>
              <tr class="table-light">
                <td></td>
                <td class="fw-semibold">Total other expenses (to line 27a &amp; 48)</td>
                <td class="text-end fw-bold">
                  {{ schedule.line_48_total|floatformat:2|intcomma }}
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- Bottom Recalculate button (mobile-friendly) -->
    <div class="text-end mb-5">
      <button type="submit" name="action" value="recalc" class="btn btn-dark">
        <i class="fa-solid fa-rotate"></i> Recalculate
      </button>
    </div>

  </form>
</div>

<script>
  function parseMoney(value) {
    if (!value) return 0;
    var num = parseFloat(String(value).replace(/,/g, ""));
    return isNaN(num) ? 0 : num;
  }

  function recalcCOGS() {
    var l35 = parseMoney(document.getElementById("id_line_35")?.value);
    var l36 = parseMoney(document.getElementById("id_line_36")?.value);
    var l37 = parseMoney(document.getElementById("id_line_37")?.value);
    var l38 = parseMoney(document.getElementById("id_line_38")?.value);
    var l39 = parseMoney(document.getElementById("id_line_39")?.value);
    var l41 = parseMoney(document.getElementById("id_line_41")?.value);

    var l40 = l35 + l36 + l37 + l38 + l39;
    var l42 = l40 - l41;

    var line40Input = document.getElementById("id_line_40");
    var line42Input = document.getElementById("id_line_42");
    if (line40Input) line40Input.value = l40 ? l40.toFixed(2) : "";
    if (line42Input) line42Input.value = l42 ? l42.toFixed(2) : "";

    var line4Input = document.getElementById("id_line_4");
    if (line4Input) {
      line4Input.value = l42 ? l42.toFixed(2) : "";
    }
  }

  document.querySelectorAll(".line35-41").forEach(function (input) {
    input.addEventListener("input", recalcCOGS);
  });

  recalcCOGS();
</script>
{% endblock %}
