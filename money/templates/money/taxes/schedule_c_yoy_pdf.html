{% load humanize %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    @page { size: Letter landscape; margin: 0.5in; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      font-size: 10px;
      color: #111;
    }

    .header { margin-bottom: 10px; }

    h1 { font-size: 16px; margin: 0 0 4px; }

    .meta {
      font-size: 9px;
      color: #555;
      margin-bottom: 10px;
    }

    table { width: 100%; border-collapse: collapse; }

    th, td {
      padding: 6px 6px;
      border-bottom: 1px solid #e6e6e6;
      vertical-align: top;
    }

    thead th {
      border-bottom: 2px solid #333;
      text-align: left;
      font-size: 9px;
      letter-spacing: .2px;
    }

    .right { text-align: right; }
    .muted { color: #666; }

    .col-line { width: 70px; }
    .col-name { width: 320px; }
    .col-year { width: 115px; }
    .amt { white-space: nowrap; }

    /* Match UI: shaded line header row */
    .line-row {
      background: #f1f3f5;
      font-weight: 700;
      page-break-after: avoid;   /* helps reduce orphaned headers */
      break-after: avoid;
    }

    /* Sub rows */
    .sub-name { padding-left: 14px; }

    /* Final total row */
    .total-row td {
      border-top: 2px solid #333;
      border-bottom: 0;
      padding-top: 8px;
      font-weight: 700;
      background: #fff;
    }

    .total-row {
      page-break-inside: avoid;
      break-inside: avoid;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>Operating Expenses (3-Year YoY)</h1>
    <div class="meta">
      Ending year: {{ selected_year }} · Tax-deductible totals (meals {{ meals_rate|floatformat:0 }}%, excludes personal-vehicle fuel)
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th class="col-line">Sched C</th>
        <th class="col-name">Category / Sub-category</th>
        {% for y in years %}
          <th class="right col-year">{{ y }}</th>
        {% endfor %}
      </tr>
    </thead>

    <tbody>
      {% for line in lines %}
        <tr class="line-row">
          <td>{{ line.line }}</td>
          <td>{{ line.category_label|default:"—" }}</td>
          {% for v in line.values %}
            <td class="right amt">${{ v|floatformat:2|intcomma }}</td>
          {% endfor %}
        </tr>

        {% for sub in line.subrows %}
          <tr>
            <td class="muted"></td>
            <td class="sub-name">{{ sub.name }}</td>
            {% for v in sub.values %}
              <td class="right amt">${{ v|floatformat:2|intcomma }}</td>
            {% endfor %}
          </tr>
        {% endfor %}
      {% endfor %}

      <!-- Final total row (inside tbody so it won't repeat) -->
      <tr class="total-row">
        <td colspan="2" class="right">Total Operating Expenses</td>
        {% for t in grand_totals %}
          <td class="right amt">${{ t|floatformat:2|intcomma }}</td>
        {% endfor %}
      </tr>
    </tbody>
  </table>
</body>
</html>
