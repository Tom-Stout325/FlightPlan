{% extends 'index.html' %}
{% load static %}
{% load humanize %}
{% load finance_tags %}

{% block title %}Transactions{% endblock %}

{% block extra_css %}
<style>
  /* Make the main card feel edge-to-edge on phones, without transforms */
  @media (max-width: 576.98px) {
    .transactions-shell {
      width: 100%;
      border-radius: 0;
      border-left: none;
      border-right: none;
    }
    .mobile-edge {
      margin-left: 0;
      margin-right: 0;
    }
  }

  /* Filter buttons: stack on mobile, inline on larger screens */
  .filter-actions .btn {
    width: 100%;
  }
  @media (min-width: 576px) {
    .filter-actions .btn {
      width: auto;
    }
  }
</style>
{% endblock %}


{% block content %}

<div class="container-fluid px-0 px-md-5 mt-4">
  <h2 class="text-center text-primary">TRANSACTIONS</h2>

  <div class="bg-light border rounded p-3 p-md-4 mt-3 transactions-shell">

    {# FILTER FORM #}
    <form method="get" class="mb-4">
      <h4 class="text-info text-center mb-3">Filter Transactions</h4>

      <div class="row g-2">
        <div class="col-12 col-md-3">
          <select name="event" class="form-select">
            <option value="">All Events</option>
            {% for event in events %}
              <option value="{{ event.id }}" {% if selected_event == event.id|stringformat:"s" %}selected{% endif %}>
                {{ event }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-3">
          <select name="category" class="form-select">
            <option value="">All Categories</option>
            {% for category in categories %}
              <option value="{{ category.id }}" {% if selected_category == category.id|stringformat:"s" %}selected{% endif %}>
                {{ category.category }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-3">
          <select name="sub_cat" class="form-select">
            <option value="">All Sub-Categories</option>
            {% for sub_cat in subcategories %}
              <option value="{{ sub_cat.id }}" {% if selected_sub_cat == sub_cat.id|stringformat:"s" %}selected{% endif %}>
                {{ sub_cat.sub_cat }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-3">
          <select name="year" class="form-select">
            <option value="">All Years</option>
            {% for year in years %}
              <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>
                {{ year }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="mt-3 filter-actions d-flex flex-column flex-sm-row gap-2 justify-content-center">
        <button type="submit" class="btn btn-outline-info" name="apply_filters">
          Apply Filters
        </button>
        <a href="{% url 'money:transactions' %}" class="btn btn-outline-info">
          Clear Filters
        </a>
      </div>
    </form>

    {# DOWNLOAD + ACTION BUTTONS #}
    <div class="d-flex flex-column flex-sm-row gap-2 my-3 justify-content-center">
      <a href="{% url 'money:export_transactions_csv' %}?{% if selected_year %}year={{ selected_year }}{% endif %}"
         class="btn btn-outline-success">
        Download CSV
      </a>
      <a href="{% url 'money:add_transaction' %}" class="btn btn-outline-primary">
        Enter a Transaction
      </a>
      <a href="{% url 'money:recurring_transaction_list' %}" class="btn btn-outline-success">
        Recurring Transactions
      </a>
    </div>

    {# TRANSACTIONS TABLE #}
    <div class="table-responsive mobile-edge mt-3">
      <table class="table table-hover align-middle">
        <thead class="table-primary text-center">
          <tr>
            {# Date: short format label is fine everywhere #}
            <th>Date</th>

            {# Type: visible everywhere #}
            <th>Type</th>

            {# Desktop-only extra columns #}
            <th class="d-none d-md-table-cell">Invoice #</th>
            <th class="d-none d-md-table-cell">Description</th>

            {# Amount: visible everywhere #}
            <th>Amount</th>

            {# Actions: view only on mobile, full set on desktop #}
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for transaction in transactions %}
          <tr class="text-center">
            {# DATE — short format #}
            <td>{{ transaction.date|date:"m/d/y" }}</td>

            {# TYPE — e.g., Income / Expense #}
            <td>{{ transaction.trans_type }}</td>

            {# DESKTOP-ONLY DETAILS #}
            <td class="d-none d-md-table-cell">
              {% if transaction.invoice_number %}
                {{ transaction.invoice_number }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>

            <td class="d-none d-md-table-cell">
              {{ transaction.transaction }}
            </td>

            {# AMOUNT — visible everywhere #}
            <td>${{ transaction.amount|floatformat:2|intcomma }}</td>

            {# ACTIONS #}
            <td class="text-nowrap">
              {# View: always visible #}
              <a href="{% url 'money:transaction_detail' transaction.id %}"
                 class="text-decoration-none me-2"
                 title="View">
                <i class="fa-solid fa-eye text-primary"></i>
              </a>

              {# Edit/Delete: desktop only #}
              <span class="d-none d-md-inline">
                <a href="{% url 'money:edit_transaction' transaction.id %}"
                   class="text-decoration-none me-2"
                   title="Edit">
                  <i class="fa-solid fa-pencil text-primary"></i>
                </a>
                <a href="{% url 'money:delete_transaction' transaction.id %}"
                   class="text-decoration-none me-2"
                   title="Delete">
                  <i class="fa-solid fa-trash-can text-primary"></i>
                </a>
              </span>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="text-center text-muted">
              No transactions found.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {# PAGINATION #}
    {% if is_paginated %}
      <div class="d-flex justify-content-center mt-3">
        <nav>
          <ul class="pagination">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?{% query_transform request.GET page=1 %}">« First</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?{% query_transform request.GET page=page_obj.previous_page_number %}">
                  Previous
                </a>
              </li>
            {% endif %}
            <li class="page-item disabled">
              <span class="page-link">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
              </span>
            </li>
            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?{% query_transform request.GET page=page_obj.next_page_number %}">
                  Next
                </a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?{% query_transform request.GET page=page_obj.paginator.num_pages %}">
                  Last »
                </a>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    {% endif %}

  </div>
</div>

{% endblock %}
