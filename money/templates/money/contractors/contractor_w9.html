{% extends "index.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}W-9 Intake{% endblock %}


{% block extra_css %}
<style>
  /* Clean, Safari-safe radio alignment */
  .form-check {
    display: flex;
    align-items: center;        /* vertical alignment */
    gap: .5rem;                 /* space between radio + text */
    margin-bottom: .35rem;      /* space between options */
  }

  .form-check-input {
    margin: 0;                  /* remove Safari default offset */
    flex-shrink: 0;
  }

  .form-check-label {
    margin: 0;
    line-height: 1.3;
    cursor: pointer;
  }
</style>
{% endblock %}


{% block extra_js %}
<script>
  (function () {
    const taxRadios = document.querySelectorAll('input[name="tax_classification"]');
    const llcWrapper = document.getElementById("llc-tax-wrapper");

    function toggleLLC() {
      const selected = document.querySelector('input[name="tax_classification"]:checked');
      if (!llcWrapper) return;
      llcWrapper.classList.toggle("d-none", !(selected && selected.value === "llc"));
    }

    taxRadios.forEach(r => r.addEventListener("change", toggleLLC));
    toggleLLC();
  })();
</script>

<script>
(function() {
  const canvas = document.getElementById("sigCanvas");
  const clearBtn = document.getElementById("sigClear");
  const hiddenInput = document.getElementById("id_signature_data");
  if (!canvas || !hiddenInput) return;

  const ctx = canvas.getContext("2d");
  let drawing = false;
  let last = null;

  function resizeCanvas() {
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    ctx.setTransform(1, 0, 0, 1, 0, 0);

    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.scale(dpr, dpr);

    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.strokeStyle = "#111";
  }

  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    const t = e.touches && e.touches[0];
    const x = (t ? t.clientX : e.clientX) - rect.left;
    const y = (t ? t.clientY : e.clientY) - rect.top;
    return { x, y };
  }

  function start(e) { e.preventDefault(); drawing = true; last = getPos(e); }
  function move(e) {
    if (!drawing) return;
    e.preventDefault();
    const pos = getPos(e);
    ctx.beginPath();
    ctx.moveTo(last.x, last.y);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    last = pos;
  }
  function end(e) {
    if (!drawing) return;
    e.preventDefault();
    drawing = false;
    last = null;
    hiddenInput.value = canvas.toDataURL("image/png");
  }

  function clearSig() {
    const rect = canvas.getBoundingClientRect();
    ctx.clearRect(0, 0, rect.width, rect.height);
    hiddenInput.value = "";
  }

  resizeCanvas();
  window.addEventListener("resize", () => { resizeCanvas(); hiddenInput.value = ""; });

  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", move);
  window.addEventListener("mouseup", end);

  canvas.addEventListener("touchstart", start, { passive: false });
  canvas.addEventListener("touchmove", move, { passive: false });
  window.addEventListener("touchend", end, { passive: false });

  if (clearBtn) clearBtn.addEventListener("click", clearSig);
})();
</script>
{% endblock %}

{% block content %}
<div class="container my-4" style="max-width: 980px;">

  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-2 mb-3">
    <div>
      <h2 class="mb-1">W-9 Contractor Information</h2>
      <div class="text-muted">For: <strong>{{ contractor }}</strong></div>
    </div>

    <a class="btn btn-outline-primary"
       href="{{ irs_w9_pdf_url }}"
       target="_blank" rel="noopener">
      Download IRS W-9 (PDF)
    </a>
  </div>

  {% if submitted %}
    <div class="alert alert-success">
      Thanks — your W-9 information was submitted.
    </div>
  {% endif %}

  <form method="post" class="card shadow-sm">
    <div class="card-body">
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      <div class="row g-3">

        <div class="col-12">
          <h5 class="mb-2">Your Information</h5>
        </div>

        <div class="col-12 col-md-6">
          {{ form.full_name|as_crispy_field }}
        </div>

        <div class="col-12 col-md-6">
          {{ form.business_name|as_crispy_field }}
        </div>

        <div class="col-12">
          <h5 class="mt-2 mb-2">Tax Classification</h5>
          <div class="text-muted small mb-2">Federal tax classification (W-9)</div>
          {{ form.tax_classification|as_crispy_field }}

          <div class="alert alert-info py-2 small mb-0">
            <strong>LLC help:</strong> If you choose <strong>LLC</strong>, select how the LLC is taxed:
            <strong>C</strong> (C-Corp), <strong>S</strong> (S-Corp), or <strong>P</strong> (Partnership).
            Single-member LLCs (“disregarded entity”) usually choose <strong>Individual / Sole proprietor</strong>.
          </div>

          <div id="llc-tax-wrapper" class="row g-3 mt-2 d-none">
            <div class="col-12 col-md-6">
              {{ form.llc_tax_class|as_crispy_field }}
            </div>
            <div class="col-12 col-md-6">
              {{ form.other_tax_class|as_crispy_field }}
            </div>
          </div>
        </div>

        <div class="col-12">
          <h5 class="mt-2 mb-2">Address</h5>
        </div>

        <div class="col-12 col-md-6">
          {{ form.address_line1|as_crispy_field }}
        </div>

        <div class="col-12 col-md-6">
          {{ form.address_line2|as_crispy_field }}
        </div>

        <div class="col-12">
          <h5 class="mt-2 mb-2">Taxpayer Identification Number</h5>
        </div>

        <div class="col-12 col-md-4">
          {{ form.tin_type|as_crispy_field }}
        </div>

        <div class="col-12 col-md-8">
          {{ form.tin|as_crispy_field }}
        </div>

        <div class="col-12">
          <hr class="my-3" />
          <h5 class="mb-2">Signature & Certification</h5>
          <p class="text-muted mb-2">Sign below and confirm the certification statement.</p>
        </div>

        <div class="col-12">
          <div class="border rounded p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-semibold">Draw your signature</div>
              <button type="button" id="sigClear" class="btn btn-sm btn-outline-secondary">Clear</button>
            </div>

            <div class="ratio ratio-21x9 border rounded bg-white">
              <canvas id="sigCanvas" class="w-100 h-100"></canvas>
            </div>

            {{ form.signature_data }}

            <div class="small text-muted mt-2">
              You can sign with mouse, trackpad, or finger.
            </div>
          </div>
        </div>

        <div class="col-12 col-md-6">
          {{ form.signature_name|as_crispy_field }}
        </div>

        <div class="col-12">
          {{ form.attestation|as_crispy_field }}
        </div>

        <div class="col-12 d-grid d-md-flex justify-content-md-end gap-2 mt-2">
          <button class="btn btn-primary btn-lg" type="submit">
            Submit W-9 Info
          </button>
        </div>

      </div>
    </div>
  </form>
</div>
{% endblock %}
