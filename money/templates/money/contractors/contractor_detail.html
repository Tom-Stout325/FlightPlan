{% extends "index.html" %}
{% load humanize %}

{% block title %}Contractor{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-md-3">

  <!-- Top row: Contractor info + Actions -->
  <div class="row g-2 mb-3">
    <!-- Contractor info -->
    <div class="col-12 col-lg-4 card shadow-sm h-100">
      <h1 class="h3 mb-0 text-primary text-center mt-5">{{ contractor.display_name }}</h1>
      <hr class="text-primary w-50 mx-auto">
      <div class="text-muted small my-3">
        <ul>
          <li> Name: <span class="fw-bold">{{ contractor.first_name }} {{ contractor.last_name }}</span></li>
          <li>Contractor #:  <span class="fw-bold">{{ contractor.contractor_number }}</span></li>
          <li>Type:  <span class="fw-bold">{{ contractor.get_entity_type_display }}</span></li>
          <li>Email: <span class="fw-bold">{{contractor.email }}</span></li>
          <li>Phone: <span class="fw-bold">{{ contractor.phone }}</span></li>
        </ul>
      </div>
      <hr class="text-primary w-50 mx-auto">
      <div class="mt-2 flex-wrap text-center">
        <a class="text-success text-decoration-none" href="{% url 'money:contractor_list' %}">
          <i class="fa-solid fa-arrow-left me-1"></i>Back
        </a>
        &nbsp;&nbsp;
        <a class="text-decoration-none" href="{% url 'money:contractor_edit' contractor.pk %}">
          <i class="fa-solid fa-pen-to-square me-1"></i>Edit
        </a>
      </div>
    </div>

    <!-- Actions -->
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm h-100">
        <div class="card-body p-3">
          <div class="fw-semibold mb-2">Actions</div>

          <div class="row g-2">
            <div class="col-12 col-md-6">
              <form method="post"
                    action="{% url 'money:contractor_send_w9_email' contractor.pk %}">
                {% csrf_token %}
                <button class="btn btn-primary w-100 d-flex align-items-center justify-content-center gap-2"
                        {% if not contractor.email %}disabled{% endif %}>
                  <i class="fa-solid fa-paper-plane"></i>
                  Send W-9
                </button>
              </form>
            </div>

            <div class="col-12 col-md-6">
              <form method="post"
                    action="{% url 'money:contractor_1099_generate_store' contractor.id selected_year %}">
                {% csrf_token %}
                <button class="btn btn-outline-secondary w-100 d-flex align-items-center justify-content-center gap-2">
                  <i class="fa-solid fa-box-archive"></i>
                  Store 1099 PDFs
                </button>
              </form>
            </div>

            <div class="col-12 col-md-6">
              <a class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center gap-2"
                 href="{% url 'money:contractor_1099_copy_b' contractor.id selected_year %}"
                 target="_blank">
                <i class="fa-solid fa-file-pdf"></i>
                View Copy B
              </a>
            </div>

            <div class="col-12 col-md-6">
              <a class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center gap-2"
                 href="{% url 'money:contractor_1099_copy_1' contractor.id selected_year %}"
                 target="_blank">
                <i class="fa-solid fa-file-pdf"></i>
                View Copy 1
              </a>
            </div>

            <div class="col-12">
              <form method="post"
                    action="{% url 'money:contractor_1099_email_copy_b' contractor.id selected_year %}">
                {% csrf_token %}
                <button class="btn btn-success w-100 d-flex align-items-center justify-content-center gap-2"
                        {% if not contractor.email %}disabled{% endif %}>
                  <i class="fa-solid fa-paper-plane"></i>
                  Email Copy B
                </button>
              </form>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
  <!-- Main content row -->
  <div class="row g-2">
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="fw-semibold mb-2">W-9</div>
          <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted small">Status</div>
              <span class="badge
                {% if contractor.w9_status == contractor.W9_VERIFIED %} bg-success
                {% elif contractor.w9_status == contractor.W9_RECEIVED or has_w9_submission or contractor.w9_received_date %} bg-primary
                {% elif contractor.w9_status == contractor.W9_REQUESTED or contractor.w9_sent_date %} bg-warning text-dark
                {% else %} bg-secondary
                {% endif %}">
                {% if contractor.w9_status == contractor.W9_RECEIVED or has_w9_submission or contractor.w9_received_date %}
                  Received
                {% else %}
                  {{ contractor.get_w9_status_display }}
                {% endif %}
              </span>
          </div>
          <div class="mt-2 small text-muted">
            Sent: {{ contractor.w9_sent_date|default:"—" }}<br>
            Received: {{ contractor.w9_received_date|default:"—" }}
          </div>

          {% if contractor.w9_document %}
            <div class="mt-3">
              <a class="btn btn-sm btn-outline-secondary" href="{{ contractor.w9_document.url }}" target="_blank" rel="noopener">
                <i class="fa-solid fa-file-pdf me-1"></i> View W-9 (PDF)
              </a>
            </div>
          {% elif has_w9_submission %}
            <div class="mt-3 d-flex align-items-center gap-2">
              <span class="text-muted small">
                W-9 received via secure form.
              </span>
                <a class="btn btn-sm btn-outline-primary"
                  href="{% url 'money:contractor_w9_admin' contractor.pk %}">
                  <i class="fa-solid fa-lock me-1"></i> View W-9
                </a>
            </div>
          {% else %}
            <div class="mt-3 text-muted small">No W-9 received yet.</div>
          {% endif %}
          <hr>
          <div class="fw-semibold mb-2">Delivery</div>
          <div class="small">
            E-delivery consent:
            {% if contractor.edelivery_consent %}
              <span class="badge bg-success">Yes</span>
            {% else %}
              <span class="badge bg-secondary">No</span>
            {% endif %}
          </div>

          <hr>

          {% if stored_1099 %}
            <div class="small text-muted mt-2">
              <div class="fw-bold mb-2"> 1099-NEC Status</div>
              Stored 1099 for {{ stored_1099.tax_year }} • Generated {{ stored_1099.generated_at|date:"M j, Y g:i A" }}
              {% if stored_1099.emailed_at %}
                • Emailed {{ stored_1099.emailed_at|date:"M j, Y g:i A" }} ({{ stored_1099.email_count }}x) to {{ stored_1099.emailed_to }}
              {% endif %}
            </div>
          {% else %}
            <div class="small text-muted mt-2">
              No stored 1099 for {{ selected_year }}.
            </div>
          {% endif %}

          <hr>
          
          <div class="fw-semibold mb-2">Contact</div>
          <div class="small text-muted">
            {% if contractor.email %}{{ contractor.email }}<br>{% endif %}
            {% if contractor.phone %}{{ contractor.phone }}<br>{% endif %}
            {% if contractor.address1 %}
              {{ contractor.address1 }}{% if contractor.address2 %}, {{ contractor.address2 }}{% endif %}<br>
              {{ contractor.city }}, {{ contractor.state }} {{ contractor.zip_code }}
            {% endif %}
          </div>

          {% if contractor.tin_last4 %}
            <div class="mt-2 small text-muted">
              TIN: {{ contractor.get_tin_type_display }} • ****{{ contractor.tin_last4 }}
            </div>
          {% endif %}

        </div>
      </div>
    </div>

    <div class="col-12 col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-2">
            <div class="fw-semibold">Linked Transactions</div>

            <form method="get" class="d-flex gap-2 align-items-center">
              <label class="small text-muted mb-0">Year</label>
              <select name="year" class="form-select form-select-sm" onchange="this.form.submit()">
                {% for y in year_choices %}
                  <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
              </select>
              <noscript><button class="btn btn-sm btn-outline-secondary" type="submit">Go</button></noscript>
            </form>
          </div>

          <div class="text-muted small mb-3">
            Total ({{ selected_year }}): <span class="fw-semibold">${{ transaction_total|floatformat:2|intcomma }}</span>
          </div>

          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Description</th>
                  <th class="text-end">Amount</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for t in transactions %}
                  <tr>
                    <td class="text-nowrap">{{ t.date }}</td>
                    <td class="min-w-0">
                      <div class="text-truncate">{{ t.transaction }}</div>
                      <div class="small text-muted text-truncate">
                        {% if t.sub_cat %}{{ t.sub_cat }}{% elif t.category %}{{ t.category }}{% endif %}
                        {% if t.event %} • {{ t.event }}{% endif %}
                      </div>
                    </td>
                    <td class="text-end text-nowrap">${{ t.amount|floatformat:2|intcomma }}</td>
                    <td class="text-end">
                      <a class="btn btn-sm btn-outline-secondary" href="{% url 'money:transaction_detail' t.pk %}">View</a>
                    </td>
                  </tr>
                {% empty %}
                  <tr><td colspan="4" class="text-muted">No transactions linked for {{ selected_year }}.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div>
      </div>

      {% if contractor.notes %}
        <div class="card shadow-sm mt-2">
          <div class="card-body">
            <div class="fw-semibold mb-1">Notes</div>
            <div class="small">{{ contractor.notes|linebreaksbr }}</div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}




