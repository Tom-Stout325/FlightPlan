{# money/templates/money/invoices/invoice_v2_form.html #}
{% extends "index.html" %}
{% load static %}

{% block title %}
  {% if invoice and invoice.pk %}
    Edit Invoice {{ invoice.invoice_number|default:"(draft)" }}
  {% else %}
    New Invoice
  {% endif %}
{% endblock %}


{% block extra_css %}
<style>
  /* Hide inline delete checkboxes; we toggle via JS */
  input[type="checkbox"][name$="-DELETE"] { display: none !important; }

  /* Slightly tighter inputs in table */
  #invoice-items-table input.form-control,
  #invoice-items-table select.form-select {
    padding-top: .35rem;
    padding-bottom: .35rem;
  }
</style>
{% endblock %}


{% block content %}
<div class="container mt-4 mb-5" style="max-width: 900px;">

  <a href="{% url 'money:invoice_list' %}" class="btn btn-link btn-sm px-0 mb-3">
    ← Back to invoices
  </a>

  <div class="card shadow-sm">
    <div class="card-body">

      <div class="d-flex justify-content-between align-items-start gap-3 mb-3">
        <div>
          <h1 class="h4 mb-1">
            {% if invoice and invoice.pk %}
              Edit Invoice {{ invoice.invoice_number|default:"(draft)" }}
            {% else %}
              New Invoice
            {% endif %}
          </h1>
          <p class="text-muted small mb-0">
            
          <div class="row g-2 mt-2">
            <div class="col-12 col-md-4">
              <label class="form-label small text-muted mb-1">Invoice #</label>
              <input
                type="text"
                id="id_invoice_number"
                class="form-control"
                value="{% if form.invoice_number.value %}{{ form.invoice_number.value }}{% elif invoice and invoice.invoice_number %}{{ invoice.invoice_number }}{% else %}{% endif %}"
                disabled
                readonly
              >
              <div class="form-text">
                Assigned from the Job number when you save.
              </div>
            </div>

            <div class="col-12 col-md-8">
              {% if invoice and invoice.pk and invoice.invoice_number %}
                <div class="alert alert-light border mb-0 h-100 d-flex align-items-center">
                  <div class="small text-muted">
                    This invoice number is locked once created.
                  </div>
                </div>
              {% else %}
                <div class="alert alert-light border mb-0 h-100 d-flex align-items-center">
                  <div class="small text-muted">
                    Select a Job to preview the next invoice number.
                  </div>
                </div>
              {% endif %}
            </div>
          </div>

          </p>
        </div>
      </div>

      <form method="post" novalidate autocomplete="off">
        {% csrf_token %}

        {# ✅ management form MUST be inside <form> #}
        {{ items_formset.management_form }}

        {# ---- Top-level errors ---- #}
        {% if form.non_field_errors %}
          <div class="alert alert-danger mb-3">
            {{ form.non_field_errors }}
          </div>
        {% endif %}

        {% if items_formset.non_form_errors %}
          <div class="alert alert-danger mb-3">
            {{ items_formset.non_form_errors }}
          </div>
        {% endif %}

        {# ---- Header Fields ---- #}
        <div class="row g-3 mb-4">

          {# Invoice number display (read-only) #}
          <div class="col-12 col-md-6">
            <label class="form-label">Invoice #</label>
            <input
              type="text"
              class="form-control"
              value="{% if invoice and invoice.invoice_number %}{{ invoice.invoice_number }}{% else %}(auto-assigned on save){% endif %}"
              readonly
            >
            <div class="form-text">
              {% if invoice and invoice.invoice_number %}
                This invoice number is assigned automatically.
              {% else %}
                The invoice number will be generated when you create the invoice.
              {% endif %}
            </div>
          </div>

          <div class="col-12 col-md-6">
            <label for="{{ form.client.id_for_label }}" class="form-label">Client</label>
            {{ form.client }}
            {% if form.client.errors %}
              <div class="invalid-feedback d-block">{{ form.client.errors|striptags }}</div>
            {% endif %}
          </div>

          <div class="col-12 col-md-6">
            <label for="{{ form.service.id_for_label }}" class="form-label">Service</label>
            {{ form.service }}
            {% if form.service.errors %}
              <div class="invalid-feedback d-block">{{ form.service.errors|striptags }}</div>
            {% endif %}
          </div>

          <div class="col-12 col-md-6">
            <label for="{{ form.event.id_for_label }}" class="form-label">Event (optional)</label>
            {{ form.event }}
            {% if form.event.errors %}
              <div class="invalid-feedback d-block">{{ form.event.errors|striptags }}</div>
            {% endif %}
          </div>

          <div class="col-12 col-md-6">
            <label for="{{ form.event_name.id_for_label }}" class="form-label">Event name (display)</label>
            {{ form.event_name }}
            {% if form.event_name.errors %}
              <div class="invalid-feedback d-block">{{ form.event_name.errors|striptags }}</div>
            {% endif %}
          </div>

          <div class="col-12">
            <label for="{{ form.location.id_for_label }}" class="form-label">Location</label>
            {{ form.location }}
            {% if form.location.errors %}
              <div class="invalid-feedback d-block">{{ form.location.errors|striptags }}</div>
            {% endif %}
          </div>

          <div class="col-6 col-md-4">
            <label for="{{ form.date.id_for_label }}" class="form-label">Invoice date</label>
            {{ form.date }}
            {% if form.date.errors %}
              <div class="invalid-feedback d-block">{{ form.date.errors|striptags }}</div>
            {% endif %}
          </div>

          <div class="col-6 col-md-4">
            <label for="{{ form.due.id_for_label }}" class="form-label">Due date</label>
            {{ form.due }}
            {% if form.due.errors %}
              <div class="invalid-feedback d-block">{{ form.due.errors|striptags }}</div>
            {% endif %}
          </div>

          <div class="col-6 col-md-4">
            <label for="{{ form.paid_date.id_for_label }}" class="form-label">Paid date</label>
            {{ form.paid_date }}
            {% if form.paid_date.errors %}
              <div class="invalid-feedback d-block">{{ form.paid_date.errors|striptags }}</div>
            {% endif %}
          </div>

          <div class="col-6 col-md-4">
            <label for="{{ form.status.id_for_label }}" class="form-label">Status</label>
            {{ form.status }}
            {% if form.status.errors %}
              <div class="invalid-feedback d-block">{{ form.status.errors|striptags }}</div>
            {% endif %}
          </div>

        </div>

        <hr class="my-4">

        {# ---- Line Items ---- #}
        <div class="d-flex justify-content-between align-items-end gap-3 mb-2">
          <div>
            <h2 class="h6 mb-0">Line items</h2>
            <p class="small text-muted mb-0">Add one or more items.</p>
          </div>

          <button type="button" class="btn btn-outline-primary btn-sm" id="add-line-item-btn">
            + Add line item
          </button>
        </div>

        <div class="table-responsive mb-3">
          <table class="table table-sm align-middle mb-0" id="invoice-items-table">
            <thead class="table-light">
              <tr>
                <th>Description</th>
                <th style="width: 90px;" class="text-end">Qty</th>
                <th style="width: 120px;" class="text-end">Price</th>
                <th style="width: 240px;">Sub Category</th>
                <th style="width: 80px;" class="text-center">Delete</th>
              </tr>
            </thead>

            <tbody id="invoice-items-body">
              {% for f in items_formset %}
                <tr class="invoice-item-row">
                  {# ✅ include all hidden fields (id, etc.) #}
                  {% for hidden in f.hidden_fields %}{{ hidden }}{% endfor %}

                  <td>
                    {{ f.description }}
                    {% if f.description.errors %}
                      <div class="invalid-feedback d-block small">
                        {{ f.description.errors|striptags }}
                      </div>
                    {% endif %}
                    {% if f.non_field_errors %}
                      <div class="invalid-feedback d-block small">
                        {{ f.non_field_errors|striptags }}
                      </div>
                    {% endif %}
                  </td>

                  <td class="text-end">
                    {{ f.qty }}
                    {% if f.qty.errors %}
                      <div class="invalid-feedback d-block small text-start">
                        {{ f.qty.errors|striptags }}
                      </div>
                    {% endif %}
                  </td>

                  <td class="text-end">
                    {{ f.price }}
                    {% if f.price.errors %}
                      <div class="invalid-feedback d-block small text-start">
                        {{ f.price.errors|striptags }}
                      </div>
                    {% endif %}
                  </td>

                  <td>
                    {{ f.sub_cat }}
                    {% if f.sub_cat.errors %}
                      <div class="invalid-feedback d-block small">
                        {{ f.sub_cat.errors|striptags }}
                      </div>
                    {% endif %}
                  </td>

                  <td class="text-center">
                    {% if items_formset.can_delete %}
                      {{ f.DELETE }}
                      <button type="button" class="btn btn-outline-danger btn-sm js-delete-row" title="Remove line">
                        &#128465;
                      </button>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>

            <tfoot class="table-light">
              <tr>
                <th colspan="3" class="text-end">Last saved total:</th>
                <th class="text-end">
                  {% if invoice and invoice.amount %}
                    ${{ invoice.amount|floatformat:2 }}
                  {% else %}
                    $0.00
                  {% endif %}
                </th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="small text-muted mb-4">
          Totals update after saving the invoice.
        </div>

        <div class="d-flex justify-content-between gap-2">
          <a href="{% url 'money:invoice_list' %}" class="btn btn-outline-secondary">
            Cancel
          </a>
          <button type="submit" class="btn btn-primary">
            {% if invoice and invoice.pk %}
              Save changes
            {% else %}
              Create invoice
            {% endif %}
          </button>
        </div>

      </form>
    </div>
  </div>

</div>

{# ---- Empty form template for JS add-row ---- #}
<template id="item-empty-form-template">
  {% with f=items_formset.empty_form %}
    <tr class="invoice-item-row">
      {% for hidden in f.hidden_fields %}{{ hidden }}{% endfor %}
      <td>{{ f.description }}</td>
      <td class="text-end">{{ f.qty }}</td>
      <td class="text-end">{{ f.price }}</td>
      <td>{{ f.sub_cat }}</td>
      <td class="text-center">
        {% if items_formset.can_delete %}
          {{ f.DELETE }}
          <button type="button" class="btn btn-outline-danger btn-sm js-delete-row" title="Remove line">
            &#128465;
          </button>
        {% endif %}
      </td>
    </tr>
  {% endwith %}
</template>



{% block extra_js %}
<script>
  (function () {
    const addBtn = document.getElementById("add-line-item-btn");
    const tbody = document.getElementById("invoice-items-body");
    const template = document.getElementById("item-empty-form-template");
    if (!tbody || !template) return;

    // Works with prefix="items" -> items-TOTAL_FORMS
    const totalFormsInput = document.querySelector("input[name='items-TOTAL_FORMS']");
    if (!totalFormsInput) return;

    function addRow() {
      const currentCount = parseInt(totalFormsInput.value, 10) || 0;
      const html = template.innerHTML.replace(/__prefix__/g, currentCount);

      const wrapper = document.createElement("tbody");
      wrapper.innerHTML = html.trim();
      const newRow = wrapper.firstElementChild;

      tbody.appendChild(newRow);
      totalFormsInput.value = currentCount + 1;

      // focus description
      const desc = newRow.querySelector("input, textarea");
      if (desc) desc.focus();
    }

    function deleteRow(row) {
      const checkbox = row.querySelector("input[type='checkbox'][name$='-DELETE']");
      if (checkbox) {
        checkbox.checked = true;
        row.style.display = "none";
      } else {
        // New unsaved row (no DELETE field found for some reason) -> remove node
        row.remove();
      }
    }

    if (addBtn) {
      addBtn.addEventListener("click", addRow);
    }

    tbody.addEventListener("click", function (event) {
      const btn = event.target.closest(".js-delete-row");
      if (!btn) return;

      const row = btn.closest("tr");
      if (!row) return;

      deleteRow(row);
    });

    // Optional: keyboard shortcut (Ctrl/Cmd + Enter) to add row while in table
    document.addEventListener("keydown", function (e) {
      const isMac = navigator.platform.toUpperCase().includes("MAC");
      const mod = isMac ? e.metaKey : e.ctrlKey;
      if (mod && e.key === "Enter") {
        const active = document.activeElement;
        if (active && active.closest && active.closest("#invoice-items-table")) {
          e.preventDefault();
          addRow();
        }
      }
    });
  })();


(() => {
  const eventSelect = document.getElementById("id_event");
  const invoiceField = document.getElementById("id_invoice_number");
  if (!eventSelect || !invoiceField) return;

  async function suggest() {
    const eventId = eventSelect.value;
    if (!eventId) {
      invoiceField.value = "";
      return;
    }

    // Don't override existing invoice number on edit
    if (invoiceField.value && invoiceField.value.trim().length > 0) return;

    const url = "{% url 'money:invoice_v2_suggest_number' %}?event=" + encodeURIComponent(eventId);
    const resp = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" }});
    if (!resp.ok) return;

    const data = await resp.json();
    if (data.ok && data.invoice_number) {
      invoiceField.value = data.invoice_number;
    }
  }

  eventSelect.addEventListener("change", suggest);
})();
</script>

{% endblock %}

{% endblock %}
