{% extends "index.html" %}
{% load static %}

{% block title %}
  Legacy Invoice {{ invoice.invoice_number }}
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5" style="max-width: 900px;">

  <!-- Back link -->
  <a href="{% url 'money:invoice_v2_list' %}" class="btn btn-link btn-sm px-0 mb-3">
    ← Back to invoices
  </a>

  <!-- Header / meta -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex flex-column flex-md-row justify-content-between gap-3">

        <!-- Left: title + basic info -->
        <div class="flex-grow-1">
          <h1 class="h4 mb-1">
            Legacy Invoice {{ invoice.invoice_number|default:"(unknown)" }}
          </h1>

          <div class="d-flex flex-wrap align-items-center gap-2 small mb-2">
            <span class="badge bg-secondary">Legacy Invoice (Read-only)</span>
            {% if invoice.status %}
              <span class="badge bg-light text-muted">
                Status: {{ invoice.status }}
              </span>
            {% endif %}
          </div>

          <dl class="row small mt-2 mb-0">
            <dt class="col-4 col-md-3">Invoice date</dt>
            <dd class="col-8 col-md-9">
              {% if legacy_issue_date %}
                {{ legacy_issue_date|date:"M j, Y" }}
              {% elif invoice.date %}
                {{ invoice.date|date:"M j, Y" }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </dd>

            {% if invoice.due %}
              <dt class="col-4 col-md-3">Due date</dt>
              <dd class="col-8 col-md-9">
                {{ invoice.due|date:"M j, Y" }}
              </dd>
            {% endif %}

            {% if invoice.event %}
              <dt class="col-4 col-md-3">Event</dt>
              <dd class="col-8 col-md-9">
                {{ invoice.event }}
              </dd>
            {% endif %}
          </dl>
        </div>

        <!-- Right: PDF action -->
        <div class="d-flex flex-md-column flex-wrap justify-content-start justify-content-md-end gap-2">
          {% if legacy_pdf_url %}
            <a href="{{ legacy_pdf_url }}"
               class="btn btn-outline-dark btn-sm w-100"
               target="_blank">
              View Legacy PDF
            </a>
          {% else %}
            <button class="btn btn-outline-secondary btn-sm w-100" disabled>
              No PDF available
            </button>
          {% endif %}
        </div>

      </div>
    </div>
  </div>

  <!-- Client card -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h2 class="h5 mb-3">Client</h2>

      {% if invoice.client %}
        <div class="row small">
          <div class="col-12 col-md-6 mb-2">
            <div class="fw-semibold">
              {{ invoice.client.business|default:invoice.client.name|default:"(no name)" }}
            </div>
            {% if invoice.client.contact_name %}
              <div>{{ invoice.client.contact_name }}</div>
            {% endif %}
            {% if invoice.client.email %}
              <div class="text-muted">{{ invoice.client.email }}</div>
            {% endif %}
            {% if invoice.client.phone %}
              <div class="text-muted">{{ invoice.client.phone }}</div>
            {% endif %}
          </div>

          <div class="col-12 col-md-6 mb-2">
            {% if invoice.client.address_line1 %}
              <div>{{ invoice.client.address_line1 }}</div>
            {% endif %}
            {% if invoice.client.address_line2 %}
              <div>{{ invoice.client.address_line2 }}</div>
            {% endif %}
            {% if invoice.client.city or invoice.client.state or invoice.client.zip %}
              <div>
                {{ invoice.client.city }}{% if invoice.client.city and invoice.client.state %}, {% endif %}
                {{ invoice.client.state }} {{ invoice.client.zip }}
              </div>
            {% endif %}
          </div>
        </div>
      {% else %}
        <p class="text-muted mb-0 small">
          No client is associated with this legacy invoice.
        </p>
      {% endif %}
    </div>
  </div>

  <!-- Summary + Financials -->
  <div class="row g-3 mb-4">
    <!-- Summary -->
    <div class="col-12 col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h2 class="h6 mb-3">Invoice Summary</h2>
          <dl class="row small mb-0">
            <dt class="col-5">Invoice #</dt>
            <dd class="col-7">{{ invoice.invoice_number|default:"(unknown)" }}</dd>

            {% if invoice.status %}
              <dt class="col-5">Status</dt>
              <dd class="col-7">{{ invoice.status }}</dd>
            {% endif %}

            {% if invoice.event %}
              <dt class="col-5">Event</dt>
              <dd class="col-7">{{ invoice.event }}</dd>
            {% endif %}

            {% if invoice.location %}
              <dt class="col-5">Location</dt>
              <dd class="col-7">{{ invoice.location }}</dd>
            {% endif %}

            {% if invoice.notes %}
              <dt class="col-5">Notes</dt>
              <dd class="col-7">{{ invoice.notes|linebreaksbr }}</dd>
            {% endif %}
          </dl>
        </div>
      </div>
    </div>

    <!-- Financials -->
    <div class="col-12 col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h2 class="h6 mb-3">Financials</h2>
          <dl class="row small mb-0">
            {% if invoice.subtotal %}
              <dt class="col-6">Subtotal</dt>
              <dd class="col-6 text-end">
                ${{ invoice.subtotal|floatformat:2 }}
              </dd>
            {% endif %}

            {% if invoice.tax_amount %}
              <dt class="col-6">Tax</dt>
              <dd class="col-6 text-end">
                ${{ invoice.tax_amount|floatformat:2 }}
              </dd>
            {% endif %}

            <dt class="col-6 fw-semibold">Total</dt>
            <dd class="col-6 text-end fw-semibold">
              {% if legacy_total_amount %}
                ${{ legacy_total_amount|floatformat:2 }}
              {% elif invoice.total_amount %}
                ${{ invoice.total_amount|floatformat:2 }}
              {% elif invoice.amount %}
                ${{ invoice.amount|floatformat:2 }}
              {% else %}
                —
              {% endif %}
            </dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <!-- Optional legacy PDF embed -->
  {% if legacy_pdf_url %}
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h2 class="h6 mb-3">Legacy PDF Preview</h2>
        <div class="ratio ratio-4x3 mb-3">
          <iframe src="{{ legacy_pdf_url }}"
                  title="Legacy Invoice PDF"
                  style="border: 1px solid #dee2e6;"></iframe>
        </div>
        <a href="{{ legacy_pdf_url }}" target="_blank"
           class="btn btn-outline-secondary btn-sm">
          Open PDF in new tab
        </a>
      </div>
    </div>
  {% endif %}

</div>
{% endblock %}
