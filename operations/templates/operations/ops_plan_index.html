{% extends "index.html" %}

{% block extra_css %}
<style>
  /* =========================================================
     Create form sizing
     ========================================================= */
  .opsplan-create { --opsplan-h: 48px; }

  .opsplan-create .opsplan-field{
    flex: 1 1 0;
    min-width: 0;
  }

  .opsplan-create .input-group-text,
  .opsplan-create .form-select,
  .opsplan-create .form-control,
  .opsplan-create .opsplan-btn{
    height: var(--opsplan-h);
  }

  .opsplan-create .input-group-text{
    display: flex;
    align-items: center;
  }

  .opsplan-create .opsplan-btn{
    display: inline-flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    padding-left: 1rem;
    padding-right: 1rem;
    flex: 0 0 auto;
  }

  /* =========================================================
     Mobile action tiles (consistent across browsers)
     - We render ALL tiles as <button> in <form> to avoid
       <a> vs <button> differences on mobile/Safari.
     ========================================================= */
  .opsplan-mobile-actions{
    display: grid !important;
    grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
    gap: .75rem !important;
  }

  .opsplan-mobile-actions form{
    margin: 0 !important;
    width: 100% !important;
    display: block !important;
  }

  .opsplan-mobile-actions .opsplan-tile{
    width: 100% !important;
    height: 56px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 0 !important;
    line-height: 1 !important;
    border-radius: .5rem !important;

    border: 1px solid #adb5bd !important;
    background: #fff !important;
    color: #495057 !important;

    box-shadow: none !important;
    text-decoration: none !important;

    box-sizing: border-box !important;
    margin: 0 !important;
    border-width: 1px !important;
    border-style: solid !important;
    background-clip: padding-box !important;
    -webkit-appearance: none !important;
    appearance: none !important;
  }

  .opsplan-mobile-actions .opsplan-tile i{
    font-size: 1.25rem !important;
  }

  .opsplan-mobile-actions .opsplan-tile-danger{
    border-color: #dc3545 !important;
    color: #dc3545 !important;
  }

  .opsplan-mobile-actions .opsplan-tile-success{
    border-color: #198754 !important;
    color: #198754 !important;
  }

  /* Disabled tile should still keep same size/layout */
  .opsplan-mobile-actions .opsplan-tile-disabled{
    opacity: .35 !important;
    border-color: #dee2e6 !important;
    color: #adb5bd !important;
    background: #f8f9fa !important;
  }

  /* Status dropdown touch size on mobile */
  .opsplan-mobile-status select{
    min-height: 44px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- ========================================================= -->
  <!-- Create Ops Plan -->
  <!-- ========================================================= -->
  <div class="text-right mb-4 bg-light p-4 w-100 w-md-50 mx-auto shadow-sm rounded">
    <h5 class="text-center mb-3">Create an Ops Plan</h5>

    <form method="get"
          action="{% url 'operations:ops_plan_create_router' %}"
          class="d-flex flex-column flex-md-row gap-2 align-items-stretch opsplan-create">

      <div class="input-group opsplan-field">
        <span class="input-group-text">Event</span>
        <select id="eventSelect" name="event_id" class="form-select" required>
          <option value="" selected>Select an event…</option>
          {% for e in events %}
            <option value="{{ e.id }}">{{ e }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="input-group opsplan-field">
        <span class="input-group-text">Year</span>
        <input id="yearInput"
               name="year"
               type="number"
               class="form-control"
               min="2000"
               max="2100"
               value="{{ current_year }}">
      </div>

      <button class="btn btn-primary opsplan-btn" type="submit">
        <i class="fa-solid fa-plus"></i> New Ops Plan
      </button>
    </form>
  </div>

  <h3 class="text-center text-primary mb-3">Operations Plans</h3>

  {% if plans %}

    <!-- ========================================================= -->
    <!-- Desktop table -->
    <!-- ========================================================= -->
    <div class="table-responsive shadow-sm rounded d-none d-md-block">
      <table class="table table-sm table-striped align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Updated</th>
            <th>Event</th>
            <th>Year</th>
            <th>Client</th>
            <th>Email</th>
            <th class="text-center">Waivers?</th>
            <th>Status</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>

        <tbody>
          {% for p in plans %}
            <tr>
              <td>{{ p.updated_at|date:"m-d-Y" }}</td>
              <td>{{ p.event_name|default:p.event }}</td>
              <td>{{ p.plan_year }}</td>
              <td>{{ p.client|default:"—" }}</td>
              <td>{{ p.client.email|default:"—" }}</td>
              <td class="text-center">{{ p.waivers_required|yesno:"Yes,No" }}</td>

              <td>
                {% if p.status == 'Approved' %}
                  <span class="badge bg-success">{{ p.status }}</span>
                {% elif p.status == 'In Review' %}
                  <span class="badge bg-warning text-dark">{{ p.status }}</span>
                {% elif p.status == 'Archived' %}
                  <span class="badge bg-secondary">{{ p.status }}</span>
                {% else %}
                  <span class="badge bg-info text-dark">{{ p.status }}</span>
                {% endif %}
              </td>

              <td class="text-center">
                <div class="d-inline-flex flex-wrap justify-content-center align-items-center gap-2">

                  <a href="{% url 'operations:ops_plan_detail' p.pk %}"
                     class="btn btn-sm btn-outline-secondary"
                     title="View Ops Plan">
                    <i class="fa-solid fa-eye"></i>
                  </a>

                  <form method="post"
                        action="{% url 'operations:ops_plan_delete' p.pk %}"
                        class="d-inline border-0 bg-transparent shadow-none"
                        onsubmit="return confirm('Delete this Ops Plan? This cannot be undone.');">
                    {% csrf_token %}
                    <button type="submit"
                            class="btn btn-sm btn-outline-danger"
                            title="Delete Ops Plan">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </form>

                  {% if p.status == 'Draft' %}
                    <form method="post"
                          action="{% url 'operations:ops_plan_submit' p.pk %}"
                          class="d-inline border-0 bg-transparent shadow-none"
                          onsubmit="return confirm('Submit this Ops Plan for approval?');">
                      {% csrf_token %}
                      <button type="submit"
                              class="btn btn-sm btn-outline-success"
                              title="Submit for Approval">
                        <i class="fa-solid fa-paper-plane"></i>
                      </button>
                    </form>
                  {% endif %}

                  <form method="post"
                        action="{% url 'operations:ops_plan_change_status' p.pk p.status %}"
                        class="d-inline-flex align-items-center">
                    {% csrf_token %}
                    <select name="new_status"
                            class="form-select form-select-sm"
                            style="min-width: 9rem;"
                            onchange="this.form.action=this.form.action.replace('{{ p.status }}', this.value); this.form.submit();">
                      {% for status in statuses %}
                        <option value="{{ status }}" {% if status == p.status %}selected{% endif %}>
                          {% if status == p.status %}✓ {% endif %}{{ status }}
                        </option>
                      {% endfor %}
                    </select>
                  </form>

                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- ========================================================= -->
    <!-- Mobile cards -->
    <!-- ========================================================= -->
    <div class="d-md-none">
      <div class="d-flex flex-column gap-3">

        {% for p in plans %}
          <div class="card shadow-sm">
            <div class="card-body">

              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-semibold">{{ p.event_name|default:p.event }} • {{ p.plan_year }}</div>
                  <div class="text-muted small">{{ p.updated_at|date:"m-d-Y" }}</div>
                </div>

                <div>
                  {% if p.status == 'Approved' %}
                    <span class="badge bg-success">{{ p.status }}</span>
                  {% elif p.status == 'In Review' %}
                    <span class="badge bg-warning text-dark">{{ p.status }}</span>
                  {% elif p.status == 'Archived' %}
                    <span class="badge bg-secondary">{{ p.status }}</span>
                  {% else %}
                    <span class="badge bg-info text-dark">{{ p.status }}</span>
                  {% endif %}
                </div>
              </div>

              <hr class="my-3">

              <dl class="row mb-0 small">
                <dt class="col-4 text-muted">Client</dt>
                <dd class="col-8 mb-2">{{ p.client|default:"—" }}</dd>

                <dt class="col-4 text-muted">Email</dt>
                <dd class="col-8 mb-2">{{ p.client.email|default:"—" }}</dd>

                <dt class="col-4 text-muted">Waivers</dt>
                <dd class="col-8 mb-0">{{ p.waivers_required|yesno:"Yes,No" }}</dd>
              </dl>

              <div class="mt-3">

                <!-- Buttons are ALL buttons-in-forms for consistent mobile rendering -->
                <div class="opsplan-mobile-actions">

                  <!-- View -->
                  <form method="get" action="{% url 'operations:ops_plan_detail' p.pk %}">
                    <button type="submit" class="opsplan-tile" title="View">
                      <i class="fa-solid fa-eye"></i>
                    </button>
                  </form>

                  <!-- Delete -->
                  <form method="post"
                        action="{% url 'operations:ops_plan_delete' p.pk %}"
                        onsubmit="return confirm('Delete this Ops Plan? This cannot be undone.');">
                    {% csrf_token %}
                    <button type="submit" class="opsplan-tile opsplan-tile-danger" title="Delete">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </form>

                  <!-- Submit (kept as a tile always; disabled when not Draft) -->
                  {% if p.status == 'Draft' %}
                    <form method="post"
                          action="{% url 'operations:ops_plan_submit' p.pk %}"
                          onsubmit="return confirm('Submit this Ops Plan for approval?');">
                      {% csrf_token %}
                      <button type="submit" class="opsplan-tile opsplan-tile-success" title="Submit">
                        <i class="fa-solid fa-paper-plane"></i>
                      </button>
                    </form>
                  {% else %}
                    <form method="post" action="#" class="m-0">
                      <button type="button" class="opsplan-tile opsplan-tile-disabled" disabled title="Submit (disabled)">
                        <i class="fa-solid fa-paper-plane"></i>
                      </button>
                    </form>
                  {% endif %}

                </div>

                <form method="post"
                      action="{% url 'operations:ops_plan_change_status' p.pk 'Draft' %}"
                      class="opsplan-mobile-status mt-2">
                  {% csrf_token %}
                  <select class="form-select form-select-sm"
                          onchange="
                            const base = this.form.action.split('/').slice(0, -2).join('/') + '/';
                            this.form.action = base + encodeURIComponent(this.value) + '/';
                            this.form.submit();
                          ">
                    {% for status in statuses %}
                      <option value="{{ status }}" {% if status == p.status %}selected{% endif %}>
                        {% if status == p.status %}✓ {% endif %}{{ status }}
                      </option>
                    {% endfor %}
                  </select>
                </form>

              </div>

            </div>
          </div>
        {% endfor %}

      </div>
    </div>

  {% else %}
    <!-- ========================================================= -->
    <!-- Empty State -->
    <!-- ========================================================= -->
    <div class="text-center py-5">
      <h5>No Operations Plans Found</h5>
      <p class="text-muted">Create your first plan by selecting an event and year.</p>

      <form method="get"
            action="{% url 'operations:ops_plan_create_router' %}"
            class="d-inline-flex gap-2 flex-wrap justify-content-center">

        <select name="event_id" class="form-select" required>
          <option value="" selected>Select an event…</option>
          {% for e in events %}
            <option value="{{ e.id }}">{{ e }}</option>
          {% endfor %}
        </select>

        <input name="year"
               type="number"
               class="form-control"
               min="2000"
               max="2100"
               value="{{ current_year }}">

        <button class="btn btn-primary" type="submit">
          <i class="fa-solid fa-plus"></i> New Ops Plan
        </button>
      </form>
    </div>
  {% endif %}

</div>
{% endblock %}
