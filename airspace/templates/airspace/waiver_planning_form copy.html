{% extends "index.html" %}

{% block title %}
  {% if planning_mode == "edit" %}Edit Waiver Planning{% else %}Waiver Planning{% endif %}
{% endblock %}

{% block extra_css %}
<style>
  /* Keep checkboxes from inheriting big text-input styling */
  input[type="checkbox"],
  input[type="radio"] {
    width: auto;
    margin: 0 0.35rem 0 0;
    padding: 0;
    border: none;
  }

  .checkbox-group ul {
    list-style: none;
    padding-left: 0;
    margin-bottom: 0;
  }

  .checkbox-group li {
    margin-bottom: 0.25rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5" style="max-width: 900px;">

  <div class="mb-3">
    {% if planning %}
      <a href=""
         class="btn btn-primary btn-sm">
        Start Waiver Draft
      </a>
    {% endif %}
  </div>

  <div class="mb-4">
    <h1 class="h4 mb-1">
      {% if planning_mode == "edit" %}Edit Waiver Planning{% else %}Waiver Planning{% endif %}
    </h1>
    <p class="text-muted mb-0">
      Step 1 – Capture operation, aircraft, pilot, location, and safety details that will be used in the FAA waiver application and Description of Operations.
    </p>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post" novalidate>
        {% csrf_token %}

        {# -------------------------------------------------- #}
        {# Operation Basics                                   #}
        {# -------------------------------------------------- #}
        <h2 class="h6 text-uppercase text-muted mb-3">Operation Basics</h2>
        <div class="row g-3 mb-4">
          <div class="col-12">
            <label class="form-label fw-semibold" for="{{ form.operation_title.id_for_label }}">
              Operation title
            </label>
            {{ form.operation_title }}
            <div class="form-text">
              Short title for this operation (e.g., “NHRA Nationals FPV Coverage”).
            </div>
            {{ form.operation_title.errors }}
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.start_date.id_for_label }}">
              Start date
            </label>
            {{ form.start_date }}
            {{ form.start_date.errors }}
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.end_date.id_for_label }}">
              End date
            </label>
            {{ form.end_date }}
            <div class="form-text">
              Leave blank if this is a single-day operation.
            </div>
            {{ form.end_date.errors }}
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-12 col-md-5">
            <label class="form-label fw-semibold" for="{{ form.timeframe.id_for_label }}">
              Timeframe
            </label>
            {{ form.timeframe.errors }}
            <div class="checkbox-group">
              {% for choice in form.timeframe %}
                <div class="form-check">
                  {{ choice.tag }}
                  <label class="form-check-label" for="{{ choice.id_for_label }}">
                    {{ choice.choice_label }}
                  </label>
                </div>
              {% endfor %}
            </div>
            <div class="form-text mt-1">
              Select all time windows when operations may occur.
            </div>
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label fw-semibold" for="{{ form.frequency.id_for_label }}">
              Frequency
            </label>
            {{ form.frequency }}
            <div class="form-text">
              How often operations will occur during this date range.
            </div>
            {{ form.frequency.errors }}
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold" for="{{ form.local_time_zone.id_for_label }}">
              Local time zone
            </label>
            {{ form.local_time_zone }}
            <div class="form-text">
              Example: <code>America/Indiana/Indianapolis</code>.
            </div>
            {{ form.local_time_zone.errors }}
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold" for="{{ form.proposed_agl.id_for_label }}">
              Proposed AGL (ft)
            </label>
            {{ form.proposed_agl }}
            <div class="form-text">
              Maximum planned altitude above ground level in feet.
            </div>
            {{ form.proposed_agl.errors }}
          </div>
        </div>

        {# -------------------------------------------------- #}
        {# Aircraft                                            #}
        {# -------------------------------------------------- #}
        <h2 class="h6 text-uppercase text-muted mb-3">Aircraft</h2>
        <div class="row g-3 mb-4">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.aircraft.id_for_label }}">
              Drone model (from Equipment)
            </label>
            {{ form.aircraft }}
            <div class="form-text">
              Select the primary drone model you will be using. This selection will populate the Drone Safety Features later in your form.
            </div>
            {{ form.aircraft.errors }}
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.aircraft_manual.id_for_label }}">
              Other / additional drones
            </label>
            {{ form.aircraft_manual }}
            <div class="form-text">
              List any additional aircraft that may be used for this operation.
            </div>
            {{ form.aircraft_manual.errors }}
          </div>
        </div>

        {# -------------------------------------------------- #}
        {# Pilot                                               #}
        {# -------------------------------------------------- #}
        <h2 class="h6 text-uppercase text-muted mb-3">Pilot</h2>
        <div class="row g-3 mb-3">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.pilot_profile.id_for_label }}">
              Pilot (from Pilot Profile)
            </label>
            {{ form.pilot_profile }}
            <div class="form-text">
              Select yourself or a saved pilot profile, or use manual entry below.
            </div>
            {{ form.pilot_profile.errors }}
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.pilot_name_manual.id_for_label }}">
              Pilot's Name (If not in Pilot Profiles)
            </label>
            {{ form.pilot_name_manual }}
            {{ form.pilot_name_manual.errors }}
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.pilot_cert_manual.id_for_label }}">
              Part 107 Certificate Number
            </label>
            {{ form.pilot_cert_manual }}
            {{ form.pilot_cert_manual.errors }}
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.pilot_flight_hours.id_for_label }}">
              Approximate UAS flight hours
            </label>
            {{ form.pilot_flight_hours }}
            {{ form.pilot_flight_hours.errors }}
          </div>
        </div>

        {# -------------------------------------------------- #}
        {# Venue & Location                                     #}
        {# -------------------------------------------------- #}
        <h2 class="h6 text-uppercase text-muted mb-3">Venue & Location</h2>

        <div class="row g-3 mb-3">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.venue_name.id_for_label }}">
              Venue Name
            </label>
            {{ form.venue_name }}
            {{ form.venue_name.errors }}
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.street_address.id_for_label }}">
              Street Address
            </label>
            {{ form.street_address }}
            {{ form.street_address.errors }}
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold" for="{{ form.location_city.id_for_label }}">
              City
            </label>
            {{ form.location_city }}
            {{ form.location_city.errors }}
          </div>
          <div class="col-6 col-md-4">
            <label class="form-label fw-semibold" for="{{ form.location_state.id_for_label }}">
              State
            </label>
            {{ form.location_state }}
            {{ form.location_state.errors }}
          </div>
          <div class="col-6 col-md-4">
            <label class="form-label fw-semibold" for="{{ form.zip_code.id_for_label }}">
              ZIP Code
            </label>
            {{ form.zip_code }}
            {{ form.zip_code.errors }}
          </div>
        </div>

        {# Centerpoint Coordinates (DMS)                       #}
        <h2 class="h6 text-uppercase text-muted mb-2">Centerpoint Coordinates (DMS)</h2>

        <div class="row g-3 mb-3">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">Latitude (DMS)</label>

            <div class="row g-1 small text-muted mb-1">
              <div class="col-3 text-center">Deg</div>
              <div class="col-3 text-center">Min</div>
              <div class="col-3 text-center">Sec</div>
              <div class="col-3 text-center">Dir</div>
            </div>

            <div class="row g-2">
              <div class="col-3">
                {{ form.lat_deg }}
              </div>
              <div class="col-3">
                {{ form.lat_min }}
              </div>
              <div class="col-3">
                {{ form.lat_sec }}
              </div>
              <div class="col-3">
                {{ form.lat_dir }}
              </div>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">Longitude (DMS)</label>

            <div class="row g-1 small text-muted mb-1">
              <div class="col-3 text-center">Deg</div>
              <div class="col-3 text-center">Min</div>
              <div class="col-3 text-center">Sec</div>
              <div class="col-3 text-center">Dir</div>
            </div>

            <div class="row g-2">
              <div class="col-3">
                {{ form.lon_deg }}
              </div>
              <div class="col-3">
                {{ form.lon_min }}
              </div>
              <div class="col-3">
                {{ form.lon_sec }}
              </div>
              <div class="col-3">
                {{ form.lon_dir }}
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.location_radius.id_for_label }}">
              Radius
            </label>
            {{ form.location_radius }}
            {{ form.location_radius.errors }}
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.nearest_airport.id_for_label }}">
              Nearest airport
            </label>
            {{ form.nearest_airport }}
            {{ form.nearest_airport.errors }}
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold" for="{{ form.launch_location.id_for_label }}">
            Launch location description
          </label>
          {{ form.launch_location }}
          {{ form.launch_location.errors }}
        </div>

        <hr class="text-primary w-50 mx-auto my-5">

        {# -------------------------------------------------- #}
        {# Operations Over People (107.39)                     #}
        {# -------------------------------------------------- #}
        <h2 class="h6 text-uppercase text-muted mb-1">Operations Over People (107.39)</h2>

        <div class="mb-3">
          <div class="form-check form-switch">
            {{ form.operates_under_10739 }}
            <label class="form-check-label ms-2" for="{{ form.operates_under_10739.id_for_label }}">
              This operation will be conducted under an approved 14 CFR §107.39 Operations Over People waiver
            </label>
          </div>
          <div class="form-text mb-4">
            Check this box if you have an FAA-approved 107.39 waiver, Operations Over People, <strong>that applies to this operation.</strong>
          </div>
          {{ form.operates_under_10739.errors }}
        </div>

        <div id="oop-waiver-details" class="border rounded-3 p-3 bg-light mb-4 d-none">
          <div class="mb-3">
            <label class="form-label fw-semibold" for="{{ form.oop_waiver_document.id_for_label }}">
              Select approved 107.39 waiver
            </label>
            {{ form.oop_waiver_document }}
            <div class="form-text">
              This list is pulled from your General Documents. Choose the 107.39 waiver that covers this operation.
            </div>
            {{ form.oop_waiver_document.errors }}
          </div>

          <div class="mb-0">
            <label class="form-label fw-semibold" for="{{ form.oop_waiver_number.id_for_label }}">
              Approved 107.39 Waiver Number
            </label>
            {{ form.oop_waiver_number }}
            <div class="form-text">
              Example: <code>107W-2024-01234</code>. If left blank, we’ll try to pull it from the attached document.
            </div>
            {{ form.oop_waiver_number.errors }}
          </div>
        </div>

        {# -------------------------------------------------- #}
        {# Safety Equipment & Insurance                        #}
        {# -------------------------------------------------- #}
        <h2 class="h6 text-uppercase text-muted mt-4">Safety Equipment & Insurance</h2>
        <div class="row g-3 mb-3">
          <div class="col-12 col-md-4">
            <div class="form-check">
              {{ form.uses_drone_detection }}
              <label class="form-check-label ms-1" for="{{ form.uses_drone_detection.id_for_label }}">
                Drone detection in use
              </label>
            </div>
            {{ form.uses_drone_detection.errors }}
          </div>
          <div class="col-12 col-md-4">
            <div class="form-check">
              {{ form.uses_flight_tracking }}
              <label class="form-check-label ms-1" for="{{ form.uses_flight_tracking.id_for_label }}">
                Flight tracking monitored
              </label>
            </div>
            {{ form.uses_flight_tracking.errors }}
          </div>
          <div class="col-12 col-md-4">
            <div class="form-check">
              {{ form.has_visual_observer }}
              <label class="form-check-label ms-1" for="{{ form.has_visual_observer.id_for_label }}">
                Visual Observer(s) used
              </label>
            </div>
            {{ form.has_visual_observer.errors }}
          </div>
        </div>

        <div class="row g-3 my-4">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.insurance_provider.id_for_label }}">
              Insurance provider
            </label>
            {{ form.insurance_provider }}
            {{ form.insurance_provider.errors }}
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.insurance_coverage_limit.id_for_label }}">
              Coverage limit
            </label>
            {{ form.insurance_coverage_limit }}
            <div class="form-text">
              Example: <code>$5,000,000</code>.
            </div>
            {{ form.insurance_coverage_limit.errors }}
          </div>
        </div>

        {# -------------------------------------------------- #}
        {# Safety features notes                               #}
        {# -------------------------------------------------- #}
        <h2 class="h6 text-uppercase text-muted mb-3">Safety Features</h2>
        <div class="mb-5">
          <label class="form-label fw-semibold" for="{{ form.safety_features_notes.id_for_label }}">
            Safety features & mitigations
          </label>
          {{ form.safety_features_notes }}
          <div class="form-text">
            If you have selected a drone from the drop-down menu, this will be auto-populated from our drone database. If you added the drone in Other/Additional Drones, complete this field. Include redundancies, geofencing, return-to-home behavior, parachute systems, etc.
          </div>
          {{ form.safety_features_notes.errors }}
        </div>

        {# -------------------------------------------------- #}
        {# Purpose of Drone Operations                        #}
        {# -------------------------------------------------- #}
        <h2 class="h6 text-uppercase text-muted mb-3 mt-4">Purpose of Drone Operations</h2>

        <p class="text-muted small mb-2">
          Select all that apply — this will help generate the Description of Operations.
        </p>

        <div class="checkbox-group mb-3">
          {{ form.purpose_operations }}
        </div>
        {{ form.purpose_operations.errors }}

        <div class="mb-4">
          <label class="form-label fw-semibold" for="{{ form.purpose_operations_details.id_for_label }}">
            Additional Details (optional)
          </label>
          {{ form.purpose_operations_details }}
          {{ form.purpose_operations_details.errors }}
        </div>

        {# -------------------------------------------------- #}
        {# Operational Profile & Environment                  #}
        {# -------------------------------------------------- #}
        <h2 class="h6 text-uppercase text-muted mb-3 mt-4">
          Operational Profile & Environment
        </h2>

        <p class="text-muted small mb-3">
          These details help generate the FAA Description of Operations.
        </p>

        <div class="row g-3 mb-4">
          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold" for="{{ form.aircraft_count.id_for_label }}">
              Aircraft in Use
            </label>
            {{ form.aircraft_count }}
            {{ form.aircraft_count.errors }}
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold" for="{{ form.flight_duration.id_for_label }}">
              Typical Flight Duration
            </label>
            {{ form.flight_duration }}
            {{ form.flight_duration.errors }}
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold" for="{{ form.flights_per_day.id_for_label }}">
              Flights Per Day
            </label>
            {{ form.flights_per_day }}
            {{ form.flights_per_day.errors }}
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.estimated_crowd_size.id_for_label }}">
              Estimated Crowd Size
            </label>
            {{ form.estimated_crowd_size }}
            <div class="form-text">
              If unknown, provide a reasonable upper bound (e.g., “up to 15,000 spectators”).
            </div>
            {{ form.estimated_crowd_size.errors }}
          </div>

          <div class="col-12 col-md-6">
            <div class="form-check mt-4 pt-2">
              {{ form.over_moving_vehicles }}
              <label class="form-check-label ms-1" for="{{ form.over_moving_vehicles.id_for_label }}">
                Operations may occur over moving vehicles (if separately authorized).
              </label>
            </div>
            {{ form.over_moving_vehicles.errors }}
          </div>
        </div>

        <label class="form-label fw-semibold mt-2" for="{{ form.ground_environment.id_for_label }}">
          Ground Environment
        </label>
        <div class="checkbox-group mb-3">
          {{ form.ground_environment }}
        </div>
        {{ form.ground_environment.errors }}

        <label class="form-label fw-semibold mt-3" for="{{ form.prepared_procedures.id_for_label }}">
          Operational Procedures
        </label>
        <div class="checkbox-group mb-4">
          {{ form.prepared_procedures }}
        </div>
        {{ form.prepared_procedures.errors }}

        <hr class="text-primary">

        <div class="d-flex justify-content-between align-items-center mt-4">
          <a href="" class="btn btn-outline-secondary btn-sm">
            ← Back to Waivers
          </a>
          <button type="submit" class="btn btn-primary">
            {% if planning_mode == "edit" %}Save Planning{% else %}Save & Continue to Waiver Form{% endif %}
          </button>
        </div>

      </form>
    </div>
  </div>

  {% if pilot_profile_data %}
    {{ pilot_profile_data|json_script:"pilot-profile-data" }}
  {% endif %}
  {% if drone_safety_data %}
    {{ drone_safety_data|json_script:"drone-safety-data" }}
  {% endif %}

</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // -------------------------
    // Pilot profile auto-fill
    // -------------------------
    const pilotSelect = document.getElementById("id_pilot_profile");
    const certInput = document.getElementById("id_pilot_cert_manual");
    const hoursInput = document.getElementById("id_pilot_flight_hours");

    if (pilotSelect) {
      let profileMap = {};
      const dataElement = document.getElementById("pilot-profile-data");
      if (dataElement) {
        try {
          const data = JSON.parse(dataElement.textContent);
          data.forEach(function (item) {
            profileMap[String(item.id)] = item;
          });
        } catch (e) {
          console.error("Could not parse pilot profile data", e);
        }
      }

      function updatePilotFields() {
        const selectedId = pilotSelect.value;
        const profile = profileMap[selectedId];
        if (!profile) {
          return;
        }
        if (certInput && !certInput.value) {
          certInput.value = profile.license_number || "";
        }
        if (hoursInput && !hoursInput.value) {
          hoursInput.value = profile.flight_hours || "";
        }
      }

      pilotSelect.addEventListener("change", updatePilotFields);
      // Run once on load, in case a pilot is already selected
      updatePilotFields();
    }

    // -------------------------
    // Drone safety auto-fill
    // -------------------------
    const aircraftSelect = document.getElementById("id_aircraft");
    const safetyTextarea = document.getElementById("id_safety_features_notes");

    if (aircraftSelect && safetyTextarea) {
      let safetyMap = {};
      const safetyDataElement = document.getElementById("drone-safety-data");
      if (safetyDataElement) {
        try {
          const safetyData = JSON.parse(safetyDataElement.textContent);
          safetyData.forEach(function (item) {
            safetyMap[String(item.id)] = item.safety_features;
          });
        } catch (e) {
          console.error("Could not parse drone safety data", e);
        }
      }

      function updateSafetyFeatures() {
        const selectedId = aircraftSelect.value;
        const textIsEmpty = !safetyTextarea.value.trim();

        // Only fill if something is selected and the user hasn't typed anything
        if (!selectedId || !textIsEmpty) {
          return;
        }

        const safetyText = safetyMap[selectedId];
        if (safetyText) {
          safetyTextarea.value = safetyText;
        }
      }

      aircraftSelect.addEventListener("change", updateSafetyFeatures);
      // Run once on load, in case an aircraft is already selected
      updateSafetyFeatures();
    }

    // -------------------------
    // 107.39 OOP waiver toggle
    // -------------------------
    const oopToggle = document.getElementById("id_operates_under_10739");
    const oopDetails = document.getElementById("oop-waiver-details");

    function updateOopVisibility() {
      if (!oopToggle || !oopDetails) return;
      if (oopToggle.checked) {
        oopDetails.classList.remove("d-none");
      } else {
        oopDetails.classList.add("d-none");
      }
    }

    if (oopToggle && oopDetails) {
      oopToggle.addEventListener("change", updateOopVisibility);
      // Initialize on page load
      updateOopVisibility();
    }
  });
</script>

{% endblock %}
