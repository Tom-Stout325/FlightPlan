{% extends "index.html" %}

{% block title %}
  {% if planning_mode == "edit" %}Edit Waiver Planning{% else %}Waiver Planning{% endif %}
{% endblock %}

{% block extra_css %}
  {{ form.media.css }}
  <style>
    /* Keep checkboxes/radios from inheriting big text-input styling */
    input[type="checkbox"],
    input[type="radio"] {
      width: auto;
      margin: 0 0.35rem 0 0;
      padding: 0;
      border: none;
    }

    .checkbox-group ul {
      list-style: none;
      padding-left: 0;
      margin-bottom: 0;
    }

    .checkbox-group li {
      margin-bottom: 0.25rem;
    }
  </style>
{% endblock %}

{% block extra_js %}
  {{ form.media.js }}

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // -------------------------
      // Pilot profile auto-fill
      // -------------------------
      const pilotSelect = document.getElementById("id_pilot_profile");
      const certInput = document.getElementById("id_pilot_cert_manual");
      const hoursInput = document.getElementById("id_pilot_flight_hours");

      if (pilotSelect) {
        let profileMap = {};
        const dataElement = document.getElementById("pilot-profile-data");

        if (dataElement) {
          try {
            const data = JSON.parse(dataElement.textContent);
            data.forEach(function (item) {
              profileMap[String(item.id)] = item;
            });
          } catch (e) {
            console.error("Could not parse pilot profile data", e);
          }
        }

        function updatePilotFields() {
          const selectedId = pilotSelect.value;
          const profile = profileMap[selectedId];
          if (!profile) return;

          if (certInput && !certInput.value) certInput.value = profile.license_number || "";
          if (hoursInput && !hoursInput.value) hoursInput.value = profile.flight_hours || "";
        }

        pilotSelect.addEventListener("change", updatePilotFields);
        updatePilotFields();
      }

      // -------------------------
      // Drone safety auto-fill
      // -------------------------
      const aircraftSelect = document.getElementById("id_aircraft");
      const safetyTextarea = document.getElementById("id_safety_features_notes");

      if (aircraftSelect && safetyTextarea) {
        let safetyMap = {};
        const safetyDataElement = document.getElementById("drone-safety-data");

        if (safetyDataElement) {
          try {
            const safetyData = JSON.parse(safetyDataElement.textContent);
            safetyData.forEach(function (item) {
              safetyMap[String(item.id)] = item.safety_features;
            });
          } catch (e) {
            console.error("Could not parse drone safety data", e);
          }
        }

        function updateSafetyFeatures() {
          const selectedId = aircraftSelect.value;
          const textIsEmpty = !safetyTextarea.value.trim();
          if (!selectedId || !textIsEmpty) return;

          const safetyText = safetyMap[selectedId];
          if (safetyText) safetyTextarea.value = safetyText;
        }

        aircraftSelect.addEventListener("change", updateSafetyFeatures);
        updateSafetyFeatures();
      }

      // -------------------------
      // 107.39 / 107.145 toggles
      // -------------------------
      const oopToggle = document.getElementById("id_operates_under_10739");
      const oopDetails = document.getElementById("oop-waiver-details");
      if (oopToggle && oopDetails) {
        const update = () => oopDetails.classList.toggle("d-none", !oopToggle.checked);
        oopToggle.addEventListener("change", update);
        update();
      }

      const mvToggle = document.getElementById("id_operates_under_107145");
      const mvDetails = document.getElementById("mv-waiver-details");
      if (mvToggle && mvDetails) {
        const update = () => mvDetails.classList.toggle("d-none", !mvToggle.checked);
        mvToggle.addEventListener("change", update);
        update();
      }
    });
  </script>
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5" style="max-width: 900px;">

  <div class="mb-3">
    {% if planning %}
      <a href="{% url 'airspace:waiver_planning_new' %}?planning_id={{ planning.id }}"
         class="btn btn-primary btn-sm">
        Start Waiver Draft
      </a>
    {% endif %}
  </div>

  <div class="mb-4">
    <h1 class="h4 mb-1">
      {% if planning_mode == "edit" %}Edit Waiver Planning{% else %}Waiver Planning{% endif %}
    </h1>
    <p class="text-muted mb-0">
      Step 1 – Capture operation, aircraft, pilot, location, and safety details that will be used in the FAA waiver application and Description of Operations.
    </p>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post" novalidate>
        {% csrf_token %}

        {# ----------------------------- #}
        {# Operation Basics              #}
        {# ----------------------------- #}
        <h2 class="h6 text-uppercase text-muted mb-3">Operation Basics</h2>

        <div class="row g-3 mb-4">
          <div class="col-12">
            <label class="form-label fw-semibold" for="{{ form.operation_title.id_for_label }}">Operation title</label>
            {{ form.operation_title }}
            <div class="form-text">Short title (e.g., “NHRA Nationals FPV Coverage”).</div>
            {{ form.operation_title.errors }}
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.start_date.id_for_label }}">Start date</label>
            {{ form.start_date }}
            {{ form.start_date.errors }}
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.end_date.id_for_label }}">End date</label>
            {{ form.end_date }}
            <div class="form-text">Leave blank if single-day operation.</div>
            {{ form.end_date.errors }}
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-12 col-md-5">
            <label class="form-label fw-semibold" for="{{ form.timeframe.id_for_label }}">Timeframe</label>
            {{ form.timeframe.errors }}

            <div class="checkbox-group">
              {% for choice in form.timeframe %}
                <div class="form-check">
                  {{ choice.tag }}
                  <label class="form-check-label" for="{{ choice.id_for_label }}">{{ choice.choice_label }}</label>
                </div>
              {% endfor %}
            </div>

            <div class="form-text mt-1">Select all time windows when operations may occur.</div>
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label fw-semibold" for="{{ form.frequency.id_for_label }}">Frequency</label>
            {{ form.frequency }}
            {{ form.frequency.errors }}
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold" for="{{ form.local_time_zone.id_for_label }}">Local time zone</label>
            {{ form.local_time_zone }}
            {{ form.local_time_zone.errors }}
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold" for="{{ form.proposed_agl.id_for_label }}">Proposed AGL (ft)</label>
            {{ form.proposed_agl }}
            {{ form.proposed_agl.errors }}
          </div>
        </div>

        {# ----------------------------- #}
        {# Aircraft                      #}
        {# ----------------------------- #}
        <h2 class="h6 text-uppercase text-muted mb-3">Aircraft</h2>
        <div class="row g-3 mb-4">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.aircraft.id_for_label }}">Drone model (from Equipment)</label>
            {{ form.aircraft }}
            {{ form.aircraft.errors }}
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.aircraft_manual.id_for_label }}">Other / additional drones</label>
            {{ form.aircraft_manual }}
            <div class="form-text">Comma-separated full model (e.g., “DJI Avata 2, DJI Mini 4 Pro”).</div>
            {{ form.aircraft_manual.errors }}
          </div>
        </div>

        {# ----------------------------- #}
        {# Pilot                         #}
        {# ----------------------------- #}
        <h2 class="h6 text-uppercase text-muted mb-3">Pilot</h2>
        <div class="row g-3 mb-4">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.pilot_profile.id_for_label }}">Pilot (from Pilot Profile)</label>
            {{ form.pilot_profile }}
            {{ form.pilot_profile.errors }}
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.pilot_name_manual.id_for_label }}">Pilot Name (manual)</label>
            {{ form.pilot_name_manual }}
            {{ form.pilot_name_manual.errors }}
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.pilot_cert_manual.id_for_label }}">Part 107 Certificate Number</label>
            {{ form.pilot_cert_manual }}
            {{ form.pilot_cert_manual.errors }}
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.pilot_flight_hours.id_for_label }}">Approximate UAS flight hours</label>
            {{ form.pilot_flight_hours }}
            {{ form.pilot_flight_hours.errors }}
          </div>
        </div>

        {# ----------------------------- #}
        {# Venue & Location               #}
        {# ----------------------------- #}
        <h2 class="h6 text-uppercase text-muted mb-3">Venue & Location</h2>
        <div class="row g-3 mb-3">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.venue_name.id_for_label }}">Venue Name</label>
            {{ form.venue_name }}
            {{ form.venue_name.errors }}
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.street_address.id_for_label }}">Street Address</label>
            {{ form.street_address }}
            {{ form.street_address.errors }}
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold" for="{{ form.location_city.id_for_label }}">City</label>
            {{ form.location_city }}
            {{ form.location_city.errors }}
          </div>
          <div class="col-6 col-md-4">
            <label class="form-label fw-semibold" for="{{ form.location_state.id_for_label }}">State</label>
            {{ form.location_state }}
            {{ form.location_state.errors }}
          </div>
          <div class="col-6 col-md-4">
            <label class="form-label fw-semibold" for="{{ form.zip_code.id_for_label }}">ZIP Code</label>
            {{ form.zip_code }}
            {{ form.zip_code.errors }}
          </div>
        </div>

        <hr class="text-primary w-50 mx-auto my-5">

        <div class="row g-3 mb-3">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.airspace_class.id_for_label }}">Class of Airspace</label>
            {{ form.airspace_class }}
            {{ form.airspace_class.errors }}
          </div>
        </div>

        {# ----------------------------- #}
        {# Coordinates (DMS)             #}
        {# ----------------------------- #}
        <h2 class="h6 text-uppercase text-muted mb-2">Centerpoint Coordinates (DMS)</h2>

        <div class="row g-1 small text-muted mb-1">
          <div class="col-6">
            <div class="row g-1">
              <div class="col-3 text-center">Deg</div>
              <div class="col-3 text-center">Min</div>
              <div class="col-3 text-center">Sec</div>
              <div class="col-3 text-center">Dir</div>
            </div>
          </div>
          <div class="col-6 d-none d-md-block">
            <div class="row g-1">
              <div class="col-3 text-center">Deg</div>
              <div class="col-3 text-center">Min</div>
              <div class="col-3 text-center">Sec</div>
              <div class="col-3 text-center">Dir</div>
            </div>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">Latitude (DMS)</label>
            <div class="row g-2">
              <div class="col-3">{{ form.lat_deg }}</div>
              <div class="col-3">{{ form.lat_min }}</div>
              <div class="col-3">{{ form.lat_sec }}</div>
              <div class="col-3">{{ form.lat_dir }}</div>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">Longitude (DMS)</label>
            <div class="row g-2">
              <div class="col-3">{{ form.lon_deg }}</div>
              <div class="col-3">{{ form.lon_min }}</div>
              <div class="col-3">{{ form.lon_sec }}</div>
              <div class="col-3">{{ form.lon_dir }}</div>
            </div>
          </div>
        </div>

        {# ----------------------------- #}
        {# Radius + Nearest Airport      #}
        {# ----------------------------- #}
        <div class="row g-3 mb-2">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.location_radius.id_for_label }}">{{ form.location_radius.label }}</label>
            {{ form.location_radius }}
            {{ form.location_radius.errors }}
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="{{ form.nearest_airport_ref.id_for_label }}">
              Nearest airport (NASR)
            </label>
            {{ form.nearest_airport_ref }}
            <div class="form-text">
              Start typing ICAO or airport name. Select a match (preferred).
            </div>
            {{ form.nearest_airport_ref.errors }}
          </div>
        </div>

        <div class="accordion mb-3" id="airportFallbackAccordion">
          <div class="accordion-item">
            <h2 class="accordion-header" id="airportFallbackHeading">
              <button class="accordion-button collapsed py-2" type="button"
                      data-bs-toggle="collapse" data-bs-target="#airportFallbackBody"
                      aria-expanded="false" aria-controls="airportFallbackBody">
                Manual airport entry (fallback)
              </button>
            </h2>
            <div id="airportFallbackBody" class="accordion-collapse collapse"
                 aria-labelledby="airportFallbackHeading" data-bs-parent="#airportFallbackAccordion">
              <div class="accordion-body">
                <label class="form-label fw-semibold" for="{{ form.nearest_airport.id_for_label }}">
                  Nearest airport (manual)
                </label>
                {{ form.nearest_airport }}
                <div class="form-text">Use only if the NASR picker can’t find your airport.</div>
                {{ form.nearest_airport.errors }}
              </div>
            </div>
          </div>
        </div>

        {% if planning %}
          <div class="mt-2">
            {% if planning.nearest_airport_ref %}
              <div class="alert alert-light border py-2 mb-0">
                <div class="fw-semibold small">Selected Airport</div>
                <div>
                  {{ planning.nearest_airport_ref.icao }} — {{ planning.nearest_airport_ref.name }}
                  {% if planning.distance_to_airport_nm %}
                    <span class="text-muted">({{ planning.distance_to_airport_nm }} NM)</span>
                  {% endif %}
                </div>
              </div>
            {% elif planning.nearest_airport %}
              <div class="alert alert-warning py-2 mb-0">
                <div class="small mb-0">
                  Manual airport set to <strong>{{ planning.nearest_airport }}</strong>.
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}

        <hr class="text-primary my-5">

        <div class="d-flex justify-content-between align-items-center mt-4">
          <a href="{% url 'airspace:waiver_planning_list' %}" class="btn btn-outline-secondary btn-sm">
            ← Back to Waivers
          </a>
          <button type="submit" class="btn btn-primary">
            {% if planning_mode == "edit" %}Save Planning{% else %}Save & Continue to Waiver Form{% endif %}
          </button>
        </div>

      </form>
    </div>
  </div>

  {% if pilot_profile_data %}{{ pilot_profile_data|json_script:"pilot-profile-data" }}{% endif %}
  {% if drone_safety_data %}{{ drone_safety_data|json_script:"drone-safety-data" }}{% endif %}

</div>
{% endblock %}
