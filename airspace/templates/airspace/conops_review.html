{% extends "index.html" %}

{% block title %}CONOPS Review{% endblock %}


{% block extra_css  %}
  <style>
    /* Make the badge column consistent on desktop */
    @media (min-width: 992px) {
      .conops-badges {
        min-width: 220px;          /* tweak if needed */
        justify-content: flex-end;
        margin-right: .75rem;      /* reserve space before the chevron */
      }

      /* Bootstrap chevron uses margin-left:auto; remove that so it doesn't compete */
      .accordion-button.conops-btn::after {
        margin-left: 0 !important;
      }
    }
        .cover-badge{
      display:inline-block;
      margin-top: .35rem;
      padding: .18rem .55rem;
      border: 1px solid #bbb;
      border-radius: 999px;
      font-size: 9.5pt;
      letter-spacing: .02em;
      color: #333;
    }
    .badge-controlled {
      display: inline-block;
      margin-left: 8pt;
      padding: 2pt 6pt;
      font-size: 9pt;
      font-weight: 600;
      border-radius: 10pt;
      border: 1pt solid #0d6efd;
      color: #0d6efd;
      background-color: #e7f1ff;
      vertical-align: middle;
    }
  </style>

{% endblock %}

{% block extra_js %}
  <script>
      document.addEventListener("DOMContentLoaded", function () {
      const firstBadItem = document.querySelector('.accordion-item[data-conops-ok="0"]');
      if (!firstBadItem) return;

      const collapseEl = firstBadItem.querySelector(".accordion-collapse");
      if (!collapseEl) return;

      if (collapseEl.classList.contains("show")) return;

      const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });
      bsCollapse.show();

      firstBadItem.scrollIntoView({ behavior: "smooth", block: "start" });
    });

      document.addEventListener("DOMContentLoaded", function () {
        const regenBtn = document.getElementById("btn-regenerate");
        const overlay = document.getElementById("regen-overlay");
        if (!regenBtn) return;

        const spinner = regenBtn.querySelector(".spinner-border");
        const label = regenBtn.querySelector(".btn-label");
        const hint = document.getElementById("regen-hint");

        regenBtn.addEventListener("click", function () {
          // Show UI immediately
          if (label) label.textContent = "Regenerating…";
          if (spinner) spinner.classList.remove("d-none");
          if (hint) hint.classList.remove("d-none");
          if (overlay) overlay.classList.remove("d-none");

          setTimeout(() => {
            regenBtn.disabled = true;
            regenBtn.classList.add("disabled");
          }, 0);
        });

        window.addEventListener("pageshow", function () {
          if (overlay) overlay.classList.add("d-none");
          regenBtn.disabled = false;
          regenBtn.classList.remove("disabled");
          if (label) label.textContent = "Regenerate unlocked sections";
          if (spinner) spinner.classList.add("d-none");
          if (hint) hint.classList.add("d-none");
        });
      });
  </script>
{% endblock %}



{% block content %}
  <div class="container my-4" style="max-width: 1000px;">
    <div class="d-flex justify-content-between align-items-start gap-3 mb-3">
      <div>
        <h1>
          Concept of Operations
          {% with ac=planning.airspace_class|default:""|upper %}
            {% if ac in "BCDE" %}
              <span class="badge-controlled">
                Controlled Airspace Operations
              </span>
            {% endif %}
          {% endwith %}
        </h1>
        <div class="text-muted small">
          {{ application.planning.operation_title }}
        </div>
      </div>
    </div>
    <form method="post" class="mb-5" id="conops-form" novalidate>
      {% csrf_token %}

      <!-- Progress + Lock controls -->
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body py-3">

          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-semibold">CONOPS Progress</div>
            <div class="small text-muted">
              {{ complete_sections }} / {{ total_sections }} complete • {{ locked_sections }} locked • {{ total_words }} words
            </div>
          </div>

          <div class="progress" style="height: 10px;">
            {% if percent_complete == 100 %}
              <div class="progress-bar bg-success"
                  role="progressbar"
                  style="width: 100%;"
                  aria-valuenow="100"
                  aria-valuemin="0"
                  aria-valuemax="100"></div>
            {% elif percent_complete >= 70 %}
              <div class="progress-bar bg-info"
                  role="progressbar"
                  style="width: {{ percent_complete }}%;"
                  aria-valuenow="{{ percent_complete }}"
                  aria-valuemin="0"
                  aria-valuemax="100"></div>
            {% else %}
              <div class="progress-bar bg-warning"
                  role="progressbar"
                  style="width: {{ percent_complete }}%;"
                  aria-valuenow="{{ percent_complete }}"
                  aria-valuemin="0"
                  aria-valuemax="100"></div>
            {% endif %}
          </div>

          {% if percent_complete == 100 %}
            <div class="alert alert-success py-2 mt-3 mb-0">
              <div class="d-flex align-items-center gap-2">
                <i class="fa-solid fa-circle-check"></i>
                <div class="small fw-semibold mb-0">Ready to export</div>
              </div>
              <div class="small text-muted mt-1">
                All sections are complete. Next step: add PDF export for the final CONOPS.
              </div>
            </div>
          {% endif %}

          <div class="d-flex gap-2 flex-wrap mt-3">
            <button type="submit" name="action" value="lock_all" class="btn btn-outline-dark btn-sm">
              <i class="fa-solid fa-lock me-1"></i>Lock All
            </button>
            <button type="submit" name="action" value="unlock_all" class="btn btn-outline-secondary btn-sm">
              <i class="fa-solid fa-lock-open me-1"></i>Unlock All
            </button>
          </div>
        </div>
      </div>

      <!-- Page-level actions -->
      <div class="d-flex gap-2 flex-wrap mb-3">
        <button type="submit" name="action" value="save" class="btn btn-primary">
          Save CONOPS
        </button>
        <button type="submit"
                form="conops-form"
                name="action"
                value="regenerate"
                class="btn btn-primary"
                id="btn-regenerate"
                formnovalidate>
          <span class="btn-label">Generating unlocked sections</span>
          <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
        </button>
        <div class="form-text mt-2 d-none" id="regen-hint">
          Working on your CONOPS… this can take a moment.
        </div>
        {% if all_ready %}
          <a href="{% url 'airspace:conops_pdf_export' application.pk %}" class="btn btn-outline-primary btn-sm" target='_blank'>
            Export FAA CONOPS (PDF)
          </a>  
        {% else %}
          <button class="btn btn-outline-secondary btn-sm" disabled>
            Export FAA CONOPS (PDF)
          </button>
        {% endif %}
        <a href="{% url 'airspace:conops_overview' application.pk %}" class="btn btn-link text-decoration-none">
          Back
        </a>
      </div>
      <!-- Accordion -->
      <div class="accordion" id="conopsAccordion">
        {% for s in sections %}
          <div class="accordion-item" data-conops-ok="{{ s.ok|yesno:'1,0' }}">
            <h2 class="accordion-header" id="heading-{{ s.key }}">
              <button class="accordion-button collapsed d-flex align-items-center conops-btn"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapse-{{ s.key }}"
                      aria-expanded="false"
                      aria-controls="collapse-{{ s.key }}">

                <!-- LEFT: Title -->
                <span class="fw-semibold text-truncate">
                  {{ s.title }}
                </span>

                <span class="ms-auto d-flex align-items-center gap-2 text-nowrap conops-badges">
                  {% if s.obj.locked %}
                    <span class="badge bg-dark">
                      <i class="fa-solid fa-lock me-1"></i>Locked
                    </span>
                  {% endif %}

                  {% if s.ok %}
                    <span class="badge bg-success">
                      <i class="fa-solid fa-check me-1"></i>Ready
                    </span>
                  {% else %}
                    <span class="badge bg-warning text-dark">
                      <i class="fa-solid fa-triangle-exclamation me-1"></i>Needs info
                    </span>
                  {% endif %}
                </span>
              </button>
            </h2>
            <div id="collapse-{{ s.key }}"
                class="accordion-collapse collapse"
                aria-labelledby="heading-{{ s.key }}"
                data-bs-parent="#conopsAccordion">
              <div class="accordion-body">
                {% if not s.ok %}
                  <div class="alert alert-warning py-2">
                    <div class="small fw-semibold mb-1">Missing information</div>
                    <ul class="small mb-2">
                      {% for m in s.missing %}
                        <li>{{ m }}</li>
                      {% endfor %}
                    </ul>
                    {% if s.fix_url %}
                      <a class="btn btn-sm btn-outline-dark" href="{{ s.fix_url }}">Fix missing info</a>
                    {% endif %}
                  </div>
                {% endif %}
                {% if s.auto_only %}
                  <div class="border rounded p-3 bg-body-tertiary">
                    <div class="small text-muted mb-2">Auto-generated section</div>
                    <div class="small" style="white-space: pre-wrap;">{{ s.display_content }}</div>
                  </div>
                {% else %}
                  <label class="form-label small text-muted mb-1" for="id_content_{{ s.key }}">
                    Section text (editable)
                  </label>
                  <textarea
                    id="id_content_{{ s.key }}"
                    name="content_{{ s.key }}"
                    class="form-control"
                    rows="8"
                  >{{ s.display_content }}</textarea>
                {% endif %}
                <div class="form-check form-switch mt-3">
                  <input class="form-check-input"
                        type="checkbox"
                        role="switch"
                        id="id_locked_{{ s.key }}"
                        name="locked_{{ s.key }}"
                        {% if s.obj.locked %}checked{% endif %}>
                  <label class="form-check-label" for="id_locked_{{ s.key }}">
                    Lock this section (don’t overwrite on regenerate)
                  </label>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </form>
  </div>
  <div id="regen-overlay"
      class="position-fixed top-0 start-0 w-100 h-100 d-none"
      style="background: rgba(0,0,0,.35); z-index: 2000;">
    <div class="d-flex h-100 align-items-center justify-content-center">
      <div class="bg-white rounded-4 shadow p-4 text-center" style="max-width: 340px;">
        <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
        <div class="mt-3 fw-semibold">Generating CONOPS…</div>
        <div class="text-muted small">This can take ~30 seconds or longer.</div>
      </div>
    </div>
  </div>
{% endblock %}
